<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SUPERLIGA - Rede Social e Admin (Firebase)</title>
    <style>
        /* [Se√ß√£o de Estilos CSS] */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #050b16; color: #ffffff; line-height: 1.6; }
        header { text-align: center; padding: 40px 20px 60px; background: linear-gradient(180deg, #06142e, #050b16); border-bottom: 3px solid #00ff96; }
        /* Logo ajustada para a cor da sua imagem (verde/ciano escuro) */
        .logo { width: 180px; filter: drop-shadow(0 0 15px #00ff96); } 
        h1 { margin-top: 15px; font-size: 2.8rem; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 15px #00ff96; color: #ffffff; }
        nav { display: flex; justify-content: center; gap: 40px; padding: 20px; background: #06142e; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #00ff96; }
        nav a { color: #00ff96; text-decoration: none; font-size: 1.2rem; font-weight: bold; transition: 0.3s ease-in-out; padding: 5px 10px; border-radius: 5px; position: relative; }
        nav a:hover { color: #f2c94c; text-shadow: 0 0 10px #f2c94c; transform: scale(1.05); background: rgba(242, 201, 76, 0.1); }
        .container { width: 90%; max-width: 1200px; margin: 30px auto; padding: 0 10px; }
        .card { background: rgba(255,255,255,0.08); border: 1px solid rgba(0,255,150,0.5); padding: 25px; border-radius: 16px; margin-bottom: 35px; box-shadow: 0 0 15px rgba(0,255,150,0.3); transition: transform 0.3s ease; }
        .title { font-size: 2rem; margin-bottom: 20px; color: #00ff96; text-shadow: 0 0 10px #00ff96; border-bottom: 2px dashed rgba(0,255,150,0.4); padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 1.05rem; }
        th, td { padding: 15px 5px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.15); }
        th { background: rgba(0,255,150,0.25); color: #ffffff; font-size: 0.95rem; text-transform: uppercase; }
        tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        tr:hover { background: rgba(0,255,150,0.1); cursor: pointer; }
        .team-link { cursor: pointer; color: #f2c94c; font-weight: bold; text-shadow: 0 0 3px #f2c94c; transition: color 0.2s; }
        .link-switch { color:#f2c94c; text-decoration:none; cursor: pointer; font-weight: bold; transition: color 0.2s; }
        .action-button { background: #00ff96; color: #050b16; border: none; border-radius: 8px; padding: 12px 20px; font-weight: bold; cursor: pointer; transition: background 0.3s; box-shadow: 0 0 10px rgba(0,255,150,0.5); width: 100%; }
        .action-button:hover { background: #f2c94c; box-shadow: 0 0 15px #f2c94c; }

        /* Estilo dos Posts e Formul√°rio de Publica√ß√£o */
        .post { background: #0a1324; border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .post-author { font-weight: bold; color: #00ff96; margin-right: 10px; }
        .post-date { font-size: 0.8em; color: #999; }
        .post-content { color: #ccc; }
        #post-form-container textarea { width: 96%; padding: 10px; background: #0a1324; border: 1px solid #00ff96; border-radius: 8px; color: white; resize: vertical; min-height: 80px; }

        /* Modal e Inputs */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background: rgba(5, 11, 22, 0.95); z-index: 9999; padding-bottom: 60px; backdrop-filter: blur(5px); }
        .login-box { background:rgba(255,255,255,0.05); border:1px solid #00ff96; width:85%; max-width:420px; margin:auto; padding:35px; border-radius:14px; box-shadow:0 0 25px rgba(0,255,150,0.4); }
        .login-input { width:90%; padding:15px; background:#0a1324; border:1px solid #00ff96; border-radius:8px; color:white; margin-bottom:20px; font-size: 1rem; }
        
        .modal-header {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg,#00ff96,#06142e);
            box-shadow: 0 0 30px #00ff96;
            position: relative;
            text-align: center;
            padding-top: 40px;
            margin-bottom: 0;
        }
        .modal-content {
            width: 90%;
            max-width: 900px;
            margin: 20px auto;
        }
        /* Estilo do bot√£o de fechar no admin panel */
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 25px; 
            font-size: 30px; 
            font-weight: bold; 
            color: #ff004c; 
            cursor: pointer;
            text-decoration: none;
            line-height: 1;
            transition: color 0.2s;
        }
        .close-btn:hover {
            color: #ffffff;
        }
        
        /* NOVO CSS: REGRAS DE CLASSIFICA√á√ÉO (Brasileir√£o - 20 times) */
        .serie-a tbody tr:nth-child(-n+6) { background: rgba(0, 150, 255, 0.2); } /* Vagas para Libertadores/Sula */
        .serie-a tbody tr:nth-child(n+17) { background: rgba(255, 0, 76, 0.25); font-weight: bold; } /* ZONA DE REBAIXAMENTO (17¬™ a 20¬™) */

        .serie-b tbody tr:nth-child(-n+4) { background: rgba(0, 255, 150, 0.25); font-weight: bold; } /* ZONA DE PROMO√á√ÉO (1¬™ a 4¬™) */
        .serie-b tbody tr:nth-child(n+17) { background: rgba(255, 0, 76, 0.25); } /* ZONA DE REBAIXAMENTO (17¬™ a 20¬™) */
    </style>
</head>
<body>
    <header>
        <img src="https://i.imgur.com/gK0rG8g.png" class="logo" alt="Logo Superliga" />
        <h1>SUPERLIGA BRASILEIRA</h1>
        <button onclick="openLogin()" id="header-login-button" style="margin-top: 20px; padding: 10px 20px; background: #f2c94c; border: none; border-radius: 8px; font-weight: bold; color: #050b16; cursor: pointer; box-shadow: 0 0 10px #f2c94c; transition: background 0.3s;">
            ACESSAR CONTA
        </button>
        <button onclick="openAdminPanel()" id="admin-panel-button" style="display:none; margin-top: 20px; padding: 10px 20px; background: #ff004c; border: none; border-radius: 8px; font-weight: bold; color: #ffffff; cursor: pointer; box-shadow: 0 0 10px #ff004c; margin-left: 10px; transition: background 0.3s;">
            LOGOUT
        </button>
    </header>

    <nav>
        <a href="#feed">Feed</a>
        <a href="#series">S√©ries A e B</a>
        <a href="#times">Times Vinculados</a>
        <a href="#" onclick="openLogin()">Login/Cadastro</a>
    </nav>

    <div class="container" id="feed">
        <div class="card">
            <div class="title">üì∏ Feed Oficial</div>

            <div id="post-form-container" style="display:none; margin-bottom: 30px; padding: 15px; background: #06142e; border-radius: 10px; border: 1px solid #f2c94c;">
                <h3 style="color:#f2c94c;">O que est√° acontecendo na Superliga?</h3>
                <textarea id="post-input" placeholder="Publique uma not√≠cia, atualiza√ß√£o ou mensagem..." maxlength="300"></textarea>
                
                <input type="url" id="post-image-url" 
                       placeholder="URL da Imagem (opcional)" 
                       class="login-input" 
                       style="width: 96%; margin-top: 10px;"
                       oninput="showImagePreview(this.value)" 
                />
                
                <img id="image-preview" src="" alt="Pr√©via da Imagem" style="display:none; max-width: 96%; height: auto; margin-top: 10px; border-radius: 5px; border: 2px solid #f2c94c;">
                
                <button onclick="publishPost()" class="action-button" style="width: auto; padding: 10px 20px; margin-top: 10px;">Publicar</button>
            </div>

            <div id="feed-posts">
                </div>
        </div>
    </div>

    <div class="container" id="series">
        <div class="card">
            <div class="title">üèÜ S√©rie A ‚Äî Classifica√ß√£o</div>
            <p id="series-a-status">Nenhum time na S√©rie A.</p>
            <table id="tabela-serie-a" class="serie-a" style="display:none;">
                <thead><tr><th>#</th><th>Time</th><th>P</th><th>J</th><th>V</th><th>E</th><th>D</th><th>GP</th><th>GC</th><th>SG</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card">
            <div class="title">üí† S√©rie B ‚Äî Classifica√ß√£o</div>
            <p id="series-b-status">Nenhum time na S√©rie B.</p>
             <table id="tabela-serie-b" class="serie-b" style="display:none;">
                <thead><tr><th>#</th><th>Time</th><th>P</th><th>J</th><th>V</th><th>E</th><th>D</th><th>GP</th><th>GC</th><th>SG</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="container" id="times">
        <div class="card">
            <div class="title">üõ°Ô∏è Times Vinculados</div>
            <div id="times-list">
                <p>Nenhum time vinculado al√©m do administrador.</p>
            </div>
        </div>
    </div>

    <footer>
        SUPERLIGA ¬© 2025 ‚Äî O Campeonato Futurista do Brasil
    </footer>

<div id="perfil-time" class="modal">
    <div class="modal-header">
        <img id="perfil-time-logo" src="" class="modal-logo" alt="Logo do Time" style="width: 130px; height: 130px; filter: drop-shadow(0 0 10px #000); border-radius: 50%; border: 5px solid #fff; object-fit: cover;"/>
        <h2 id="perfil-time-nome" style="margin-top:15px; font-size:2rem; color:white; text-shadow:0 0 10px #000;"></h2>
        <p id="perfil-time-serie" style="color:#f2c94c; font-weight: bold;"></p>
        <p id="perfil-time-user-name" style="color:#00ff96; font-size: 0.9em;"></p>
        <button onclick="closePerfilTime()" class="close-btn" style="position: absolute; top: 15px; right: 25px; font-size: 30px;">X</button>
    </div>

    <div class="modal-content">
        <div class="card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 14px; border: 1px solid #00ff96; margin-bottom: 25px; box-shadow: 0 0 10px rgba(0,255,150,0.5);">
            <h3 class="title" style="color:#00ff96; margin-bottom: 15px; text-shadow: 0 0 8px #00ff96; border-bottom: 1px solid rgba(0,255,150,0.5); padding-bottom: 10px; font-size: 1.5rem;">üìä Estat√≠sticas</h3>
            <div id="perfil-time-stats">Nenhuma estat√≠stica dispon√≠vel.</div>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 14px; border: 1px solid #00ff96; margin-bottom: 25px; box-shadow: 0 0 10px rgba(0,255,150,0.5);">
            <h3 class="title" style="color:#00ff96; margin-bottom: 15px; text-shadow: 0 0 8px #00ff96; border-bottom: 1px solid rgba(0,255,150,0.5); padding-bottom: 10px; font-size: 1.5rem;">üì∞ Posts Recentes</h3>
            <div id="perfil-time-feed">Nenhum post deste time.</div>
        </div>

        <button onclick="closePerfilTime()" class="action-button">Voltar √† Liga</button>
    </div>
</div>

<div id="login" class="modal" style="padding-top:120px; text-align:center;">
    <div class="login-box">
        <img src="https://i.imgur.com/gK0rG8g.png" style="width:140px; filter:drop-shadow(0 0 10px #00ff96); margin-bottom:20px;" alt="Logo Superliga" />
        <h2 style="color:#00ff96; text-shadow:0 0 10px #00ff96; margin-bottom:25px;">ACESSO DE MEMBRO</h2>
        <input type="email" placeholder="E-mail" id="login-email" class="login-input" />
        <input type="password" placeholder="Senha" id="login-pass" class="login-input" />
        <button onclick="fazerLogin()" class="action-button">ENTRAR</button>
        <p style="font-size:0.9rem; margin-top:20px; color: #ccc;">
            Ainda n√£o tem conta? <a class="link-switch" onclick="openRegister()">Cadastre-se aqui</a>.
        </p>
        <button onclick="closeLogin()" style="padding: 10px 20px; background: transparent; border: 1px solid #00ff96; border-radius: 8px; font-weight: bold; color: #00ff96; cursor: pointer; margin-top: 15px; transition: background 0.3s;">
            Cancelar
        </button>
    </div>
</div>

<div id="register" class="modal" style="padding-top:120px; text-align:center;">
    <div class="login-box">
        <img src="https://i.imgur.com/gK0rG8g.png" style="width:140px; filter:drop-shadow(0 0 10px #00ff96); margin-bottom:20px;" alt="Logo Superliga" />
        <h2 style="color:#00ff96; text-shadow:0 0 10px #00ff96; margin-bottom:25px;">CADASTRO DE NOVO MEMBRO</h2>
        
        <input type="url" placeholder="URL da Foto de Perfil (Opcional)" id="register-profile-pic" class="login-input" />
        
        <input type="text" placeholder="Nome de Usu√°rio (Ser√° seu nome no feed)" id="register-user" class="login-input" />
        <input type="email" placeholder="E-mail do Membro (Obrigat√≥rio)" id="register-email" class="login-input" />
        <input type="password" placeholder="Senha (M√≠nimo 6 caracteres)" id="register-pass" class="login-input" />
        <button onclick="fazerCadastro()" class="action-button">CADASTRAR MEMBRO</button>
        <p style="font-size:0.9rem; margin-top:20px; color: #ccc;">
            J√° √© membro? <a class="link-switch" onclick="openLogin()">Voltar ao Login</a>.
        </p>
        <button onclick="closeRegister()" style="padding: 10px 20px; background: transparent; border: 1px solid #00ff96; border-radius: 8px; font-weight: bold; color: #00ff96; cursor: pointer; margin-top: 15px; transition: background 0.3s;">
            Cancelar
        </button>
    </div>
</div>

<div id="admin-panel" class="modal" style="padding-top:60px;">
    <div class="modal-content">
        <a href="#" onclick="fecharPainelAdmin()" class="close-btn">X</a> 

        <div class="card" style="margin-bottom: 25px; position: relative;">
            <h2 class="title" style="border-color: #ff004c;">‚öΩ REGISTRAR NOVO JOGO</h2>
            <p style="color: #ccc; margin-bottom: 15px;">Insira o placar da partida para atualizar as classifica√ß√µes.</p>

            <label style="display:block; margin-bottom: 5px; color:#00ff96;">S√©rie da Partida:</label>
            <select id="jogo-series" class="login-input" style="width:100%;" onchange="filterTeamsBySeries(this.value)">
                <option value="">-- Selecione a S√©rie --</option>
                <option value="S√©rie A">S√©rie A</option>
                <option value="S√©rie B">S√©rie B</option>
            </select>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <div style="width: 45%;">
                    <label style="display:block; margin-bottom: 5px; color:#f2c94c;">Time 1 (Casa):</label>
                    <select id="jogo-time1" class="login-input" style="width:100%;"></select>
                    <input type="number" id="jogo-gols1" placeholder="Gols Time 1" class="login-input" min="0" style="width:90%;" />
                </div>

                <div style="width: 10%; text-align: center; font-size: 1.5rem; color:#ff004c; font-weight: bold;">VS</div>

                <div style="width: 45%;">
                    <label style="display:block; margin-bottom: 5px; color:#f2c94c;">Time 2 (Visitante):</label>
                    <select id="jogo-time2" class="login-input" style="width:100%;"></select>
                    <input type="number" id="jogo-gols2" placeholder="Gols Time 2" class="login-input" min="0" style="width:90%;" />
                </div>
            </div>

            <button onclick="registrarResultado()" class="action-button" style="background: #ff004c; margin-top: 20px;">
                CALCULAR E REGISTRAR
            </button>
        </div>
        
        <div class="card">
            <h2 class="title" style="border-color: #ff004c;">üë• GEST√ÉO E VINCULA√á√ÉO DE MEMBROS</h2>
            <p style="color: #ff004c; font-weight: bold;">Vincule usu√°rios aos times das S√©ries A e B.</p>
            <div id="admin-teams-list">
                </div>
            <button onclick="fecharPainelAdmin()" class="action-button" style="background: #ff004c;">Fechar Painel</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
    // ** CONFIGURA√á√ÉO DO SEU PROJETO FIREBASE (CHAVES ATUALIZADAS) **
    const firebaseConfig = {
        apiKey: "AIzaSyAJoUwJY_EQ0LJ4g-Fvri07hDSL96qul7s", 
        authDomain: "super-liga-brasileira.firebaseapp.com",
        projectId: "super-liga-brasileira", 
        storageBucket: "super-liga-brasileira.firebasestorage.app", 
        messagingSenderId: "178822052518", 
        appId: "1:178822052518:web:1cf7c353285bf51f2d1267", 
        measurementId: "G-9G6409TNJG"
    };

    // Inicialize o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 
    const auth = firebase.auth(); 

    // Vari√°vel de Cache Local
    let usuariosCadastrados = {}; 
    let posts = [];
    let loggedInUser = null; 
    let loggedInUserUID = null; 

    // Objeto padr√£o para garantir que todos os times tenham essas chaves zeradas
    const defaultStats = { Pontos: 0, Jogos: 0, Vit√≥rias: 0, Empates: 0, Derrotas: 0, GolsPro: 0, GolsContra: 0, Saldo: 0 };


    // --- Data dos Times (S√©rie A e B 2025) ---
    const teamData = {
        'Atl√©tico-GO': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/4/4e/Atl√©tico_Clube_Goianiense_-_Escudo.png' },
        'Atl√©tico-MG': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/2/22/Clube_Atl√©tico_Mineiro_-_Escudo.png' },
        'Athletico-PR': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/2/23/Clube_Athletico-Paranaense_2020.png' },
        'Bahia': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/1/1d/Esporte_Clube_Bahia.png' },
        'Botafogo': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/2/26/Botafogo_de_Futebol_e_Regatas_logo.svg' },
        'Corinthians': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b3/Corinthians_logo.png' },
        'Crici√∫ma': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/1/1a/Crici√∫ma_Esporte_Clube.png' },
        'Cruzeiro': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/9/9f/CruzeiroEsporteClube.png' },
        'Cuiab√°': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/thumb/d/d5/Cuiab%C3%A1_Esporte_Clube_-_Escudo.png/50px-Cuiab%C3%A1_Esporte_Clube_-_Escudo.png' },
        'Flamengo': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/9/93/Flamengo-RJ_%28BRA%29.png' },
        'Fluminense': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/a/a2/Fluminense_FC_escudo.png' },
        'Fortaleza': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/4/43/Fortaleza_Esporte_Clube_novo_logo.png' },
        'Gr√™mio': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b3/Gremio_logo.png' },
        'Internacional': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/f/f1/Escudo_do_Sport_Club_Internacional.svg' },
        'Juventude': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/3/36/Juventude_logo.png' },
        'Palmeiras': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/1/10/Palmeiras_logo.svg' },
        'Red Bull Bragantino': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/5/50/Red_Bull_Bragantino_escudo.png' },
        'S√£o Paulo': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/4/4f/S%C3%A3o_Paulo_Futebol_Clube.png' },
        'Vasco': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/d/df/Escudo_do_Club_de_Regatas_Vasco_da_Gama.svg' },
        'Vit√≥ria': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/6/6f/EC_Vit√≥ria_-_Ba.png' },
        
        // --- S√âRIE B ---
        'Am√©rica-MG': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/1/1a/Am%C3%A9rica_Futebol_Clube_logo.svg' },
        'Ava√≠': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/5/54/Ava%C3%AD_Futebol_Clube.png' },
        'Botafogo-SP': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/8/87/Botafogo-SP.png' },
        'Brusque': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/c/c5/Brusque_FC.png' },
        'Cear√°': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/f/fc/Ceara_SC.png' },
        'Chapecoense': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/a/a2/Associa%C3%A7%C3%A3o_Chapecoense_de_Futebol.png' },
        'CRB': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b0/Clube_de_Regatas_Brasil.png' },
        'Goi√°s': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/5/52/Goi%C3%A1s_Esporte_Clube.png' },
        'Guarani': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/2/2d/Guarani-SP.png' },
        'Ituano': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/0/07/Ituano_Futebol_Clube.png' },
        'Novorizontino': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/1/11/Gr%C3%AAmio_Novorizontino.png' },
        'Oper√°rio-PR': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/8/8f/Oper%C3%A1rio_Ferrovi%C3%A1rio_Esporte_Clube.png' },
        'Paysandu': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/8/8e/Escudo_Paysandu.png' },
        'Ponte Preta': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/7/7b/Aapp_escudo.png' },
        'Santos': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b1/Santos_FC_logo.png' },
        'Sport': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/e/eb/Sport_Club_do_Recife.png' },
        'Vila Nova': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/d/d4/Vila_Nova_Futebol_Clube.png' },
        'Amazonas': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/thumb/d/d4/Amazonas_FC_logo.png/50px-Amazonas_FC_logo.png' },
        'Mirassol': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/c/c5/Mirassol_Futebol_Clube.png' },
        'Remo': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/thumb/4/4b/Clube_do_Remo.svg/50px-Clube_do_Remo.svg.png' },
    };

    // Usu√°rio administrador padr√£o 
    const adminUserKey = 'robbenanthony';
    const initialAdminData = { 
        email: 'robbenanthony12@gmail.com', 
        senha: 'Leoup1234', 
        isAdmin: true, 
        userName: 'Robben Anthony',
        teamName: 'Administrador', 
        series: null, 
        logo: 'https://i.imgur.com/gK0rG8g.png', // Logo da Superliga
        profilePic: 'https://i.imgur.com/gK0rG8g.png', // Logo da Superliga
        stats: defaultStats,
        uid: null 
    };

    // --- Fun√ß√µes de Sincroniza√ß√£o e Ajuda (FIREBASE) ---
    
    // NOVO: Fun√ß√£o para salvar/atualizar USU√ÅRIOS no Firestore (Cole√ß√£o 'users')
    async function saveUsersToFirestore(userKey, userData) {
        try {
            userData.stats = { ...defaultStats, ...userData.stats }; 
            await db.collection("users").doc(userKey).set(userData);
        } catch (e) {
            console.error("Erro ao salvar usu√°rio no Firestore: ", e);
            alert("Erro cr√≠tico ao salvar dados. Verifique Regras do Firestore.");
        }
    }
    
    // NOVO: Fun√ß√£o que verifica e cria o administrador no Auth e no Firestore
    async function setupAdminUser() {
        const adminEmail = initialAdminData.email;
        const adminPass = initialAdminData.senha;
        let adminUID = null;
        let firestoreDocExists = false;

        // 1. Tenta buscar o UID do ADM pelo e-mail (usando Firestore/users)
        try {
            const adminDoc = await db.collection("users").doc(adminUserKey).get();
            if (adminDoc.exists) {
                firestoreDocExists = true;
                adminUID = adminDoc.data().uid;
                initialAdminData.uid = adminUID;
            }
        } catch (e) {
             console.warn("N√£o foi poss√≠vel verificar documento admin no Firestore. Tentando criar.", e);
        }
        
        // 2. Tenta criar a conta no Firebase Auth se o doc n√£o existe ou se o UID n√£o foi encontrado
        if (!adminUID) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(adminEmail, adminPass);
                adminUID = userCredential.user.uid;
                initialAdminData.uid = adminUID;
                console.log("Conta ADM j√° existe no Auth e foi validada.");

            } catch (authError) {
                if (authError.code === 'auth/user-not-found' || authError.code === 'auth/wrong-password') {
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(adminEmail, adminPass);
                        adminUID = userCredential.user.uid;
                        initialAdminData.uid = adminUID;
                        console.log("Conta ADM criada com sucesso no Auth.");
                    } catch (e) {
                        console.error("ERRO CR√çTICO: Falha ao criar conta ADM no Auth. E-mail/Senha deve estar ativo!:", e);
                        initialAdminData.uid = "AUTH_FAILED_" + new Date().getTime();
                    }
                } else {
                    console.error("Erro de Auth do ADM (Verifique a API Key e o Auth Domain):", authError);
                }
            }
        }
        
        // 3. Garante que o documento no Firestore exista e esteja sincronizado
        if (!firestoreDocExists || initialAdminData.uid !== adminUID) {
            initialAdminData.uid = adminUID;
            await saveUsersToFirestore(adminUserKey, initialAdminData);
        }
    }

    
    // NOVO: Fun√ß√£o para carregar TODOS os dados (Usu√°rios e Posts)
    async function loadDataFromFirebase() {
        try {
            // 1. Setup do Administrador (Garanti que existe no Auth e Firestore)
            await setupAdminUser(); 

            // 2. Carregar Usu√°rios
            const userSnapshot = await db.collection("users").get();
            usuariosCadastrados = {};
            
            userSnapshot.forEach(doc => {
                const userData = doc.data();
                userData.stats = { ...defaultStats, ...userData.stats }; 
                usuariosCadastrados[doc.id] = userData;
            });
            
            // 3. Carregar Posts (ordenado do mais novo para o mais antigo)
            const postSnapshot = await db.collection("posts").orderBy("timestamp", "desc").get(); 
            posts = [];
            postSnapshot.forEach(doc => {
                posts.push({ id: doc.id, ...doc.data() });
            });
            
            console.log(`Dados carregados: ${Object.keys(usuariosCadastrados).length} usu√°rios, ${posts.length} posts.`);

        } catch (e) {
            console.error("üö® ERRO CR√çTICO: Falha ao carregar dados do Firebase. Verifique a conex√£o e as Regras de Seguran√ßa (Firestore).", e);
            alert("Falha ao carregar dados do Firebase. Verifique o console (F12) para detalhes.");
            
            if (!usuariosCadastrados[adminUserKey]) {
                 usuariosCadastrados[adminUserKey] = initialAdminData;
            }
        }
    }

    // --- Event Listener de Carregamento Principal ---
    document.addEventListener('DOMContentLoaded', async () => {
        
        await loadDataFromFirebase(); 

        const storedUser = localStorage.getItem('loggedInUser');
        if (storedUser && usuariosCadastrados[storedUser]) {
            loggedInUser = storedUser;
        }

        updateHeaderButtons(loggedInUser); 
        renderFeed();
        renderClassificationTables();
        renderTeamsList();
    });

    // --- Fun√ß√µes de Modais e Navega√ß√£o (Mantidas) ---
    function openLogin() { document.getElementById('register').style.display = 'none'; document.getElementById('login').style.display = 'block'; document.body.style.overflow = 'hidden'; }
    function closeLogin() { document.getElementById('login').style.display = 'none'; document.body.style.overflow = 'auto'; }
    function openRegister() { document.getElementById('login').style.display = 'none'; document.getElementById('register').style.display = 'block'; document.body.style.overflow = 'hidden'; }
    function closeRegister() { document.getElementById('register').style.display = 'none'; document.body.style.overflow = 'auto'; }
    function closePerfilTime() { document.getElementById('perfil-time').style.display = 'none'; document.body.style.overflow = 'auto'; }
    
    function fecharPainelAdmin() {
        document.getElementById('admin-panel').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    function openAdminPanel() {
        if (!loggedInUser || !usuariosCadastrados[loggedInUser].isAdmin) { alert('Acesso negado.'); return; }
        renderAdminTeamList();
        filterTeamsBySeries(''); 
        document.getElementById('admin-panel').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }


    // --- Fun√ß√µes de Login e Cadastro (ATUALIZADAS COM TRATAMENTO DE ERRO MELHORADO) ---
    function updateHeaderButtons(userKey) {
        const loginBtn = document.getElementById('header-login-button');
        const adminBtn = document.getElementById('admin-panel-button');
        const postForm = document.getElementById('post-form-container');

        if (userKey && usuariosCadastrados[userKey]) {
            const user = usuariosCadastrados[userKey];
            const displayName = user.userName || user.teamName || userKey;

            if (user.isAdmin) {
                adminBtn.style.display = 'inline-block';
                loginBtn.textContent = `PAINEL ADMIN (${displayName})`;
                loginBtn.onclick = openAdminPanel; 
                loginBtn.style.background = '#ff004c'; 
                adminBtn.onclick = fazerLogout;
                adminBtn.textContent = `LOGOUT`;
                adminBtn.style.background = '#f2c94c';
                adminBtn.style.display = 'inline-block';
            } else {
                loginBtn.textContent = `LOGOUT (${displayName})`;
                loginBtn.onclick = fazerLogout;
                loginBtn.style.background = '#f2c94c';
                adminBtn.style.display = 'none';
            }
            
            postForm.style.display = 'block';
        } else {
            loginBtn.textContent = 'ACESSAR CONTA';
            loginBtn.onclick = openLogin;
            adminBtn.style.display = 'none';
            postForm.style.display = 'none';
            loginBtn.style.background = '#f2c94c';
        }
    }

    async function fazerLogin() { 
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value.trim();

        if (!email || !pass) {
            alert('Preencha o e-mail e a senha.');
            return;
        }

        try {
            // 1. Tenta fazer login usando Firebase Auth
            const userCredential = await auth.signInWithEmailAndPassword(email, pass);
            const uid = userCredential.user.uid;

            // 2. Busca o usu√°rio correspondente no Firestore (pelo UID)
            const userSnapshot = await db.collection("users").where("uid", "==", uid).limit(1).get();
            
            if (!userSnapshot.empty) {
                const doc = userSnapshot.docs[0];
                loggedInUser = doc.id; // Armazena a chave de usu√°rio (username key)
                loggedInUserUID = uid;
                localStorage.setItem('loggedInUser', loggedInUser); 
                
                closeLogin();
                updateHeaderButtons(loggedInUser);
                alert(`‚úÖ Login bem-sucedido! Bem-vindo(a), ${usuariosCadastrados[loggedInUser].userName || usuariosCadastrados[loggedInUser].teamName}.`);
                renderFeed(); 
            } else {
                // Caso o login no Auth funcione, mas o usu√°rio n√£o esteja no Firestore (Problema de Regras/Sync)
                console.error("Login Auth OK, mas usu√°rio n√£o encontrado no Firestore.");
                alert('‚ùå Login bem-sucedido, mas dados do usu√°rio incompletos no Firestore. Verifique as Regras de Leitura do Firestore.');
                await auth.signOut();
            }

        } catch (error) {
            console.error("Erro no login:", error);
            let errorMessage = "‚ùå Falha no login. Verifique o e-mail e a senha.";
            
            // TRATAMENTO DE ERRO APRIMORADO
            if (error.code === 'auth/wrong-password') {
                errorMessage = "‚ùå Senha incorreta.";
            } else if (error.code === 'auth/user-not-found') {
                errorMessage = "‚ùå Usu√°rio n√£o encontrado.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "‚ùå E-mail inv√°lido.";
            } else if (error.code === 'auth/operation-not-allowed') {
                errorMessage = "üö® Provedor de E-mail/Senha desativado no Firebase Auth. **(VERIFIQUE O PASSO 2)**";
            } else if (error.code === 'auth/invalid-api-key' || error.message.includes('API Key')) {
                 errorMessage = "üö® Chave API Inv√°lida. **(VERIFIQUE O PASSO 1 - index.html)**";
            } else if (error.code === 'auth/network-request-failed') {
                 errorMessage = "üö® Falha de Conex√£o. Verifique sua Internet ou Firewall.";
            }
            
            alert(errorMessage);
        }
    }

    async function fazerLogout() {
        try {
            await auth.signOut(); 
            loggedInUser = null;
            loggedInUserUID = null;
            localStorage.removeItem('loggedInUser'); 
            updateHeaderButtons(null);
            alert('Voc√™ foi desconectado(a) com sucesso.');
            renderFeed();
        } catch (e) {
            console.error("Erro ao fazer logout:", e);
        }
    }

    async function fazerCadastro() { 
        const profilePicUrl = document.getElementById('register-profile-pic').value.trim(); 
        const user = document.getElementById('register-user').value.trim(); 
        const email = document.getElementById('register-email').value.trim();
        const pass = document.getElementById('register-pass').value.trim();

        if (!user || !email || !pass || pass.length < 6) {
            alert('üö® Por favor, preencha o Nome de Usu√°rio, E-mail, e use uma senha de no m√≠nimo 6 caracteres.');
            return;
        }
        
        const usernameKey = user.toLowerCase().replace(/\s/g, '').replace(/[√°√©√≠√≥√∫√£√µ√ß]/g, match => {
            const map = { '√°': 'a', '√©': 'e', '√≠': 'e', '√≥': 'o', '√∫': 'u', '√£': 'a', '√µ': 'o', '√ß': 'c' };
            return map[match] || match;
        });
        
        if (Object.keys(usuariosCadastrados).includes(usernameKey)) {
            alert('‚ùå Nome de usu√°rio j√° cadastrado. Tente adicionar um sobrenome ou n√∫mero.');
            return;
        }

        try {
            // 1. Cria o usu√°rio no Firebase Authentication
            const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
            const uid = userCredential.user.uid;

            // 2. Cria o documento correspondente no Firestore
            const newUser = {
                uid: uid, 
                email: email,
                senha: pass, 
                isAdmin: false,
                userName: user, 
                profilePic: profilePicUrl || 'https://via.placeholder.com/130/06142e/00ff96?text=üë§', 
                teamName: null, 
                series: null,
                logo: null, 
                stats: defaultStats 
            };

            await saveUsersToFirestore(usernameKey, newUser);
            
            // 3. Atualiza o cache local
            usuariosCadastrados[usernameKey] = newUser;
            
            alert(`üéâ Usu√°rio "${user}" cadastrado com sucesso! Agora o administrador pode vincular um time a voc√™.`);
            closeRegister();
            openLogin();

        } catch (error) {
            console.error("Erro no cadastro:", error);
            let errorMessage = "‚ùå Falha no cadastro.";
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = "‚ùå Este e-mail j√° est√° em uso.";
            } else if (error.code === 'auth/weak-password') {
                errorMessage = "‚ùå A senha √© muito fraca (m√≠nimo 6 caracteres).";
            } else if (error.code === 'auth/operation-not-allowed') {
                errorMessage = "üö® Provedor de E-mail/Senha desativado no Firebase Auth. **(VERIFIQUE O PASSO 2)**";
            }
            alert(errorMessage);
        }
    }

    // --- Fun√ß√µes de Feed (Mantidas) ---
    function showImagePreview(url) {
        const imgPreview = document.getElementById('image-preview');
        if (url) {
            imgPreview.src = url;
            imgPreview.style.display = 'block';
        } else {
            imgPreview.style.display = 'none';
            imgPreview.src = '';
        }
    }

    async function publishPost() { 
        if (!loggedInUser) {
            alert('üö® Voc√™ precisa estar logado para publicar.');
            return;
        }
        
        const currentUser = usuariosCadastrados[loggedInUser];
        
        if (!currentUser || (!currentUser.isAdmin && !currentUser.teamName)) {
             alert('üö® Sua conta precisa ser vinculada a um time pelo Administrador para publicar no feed, ou voc√™ deve ser o Administrador.');
             return;
        }

        const postContent = document.getElementById('post-input').value.trim();
        const postImage = document.getElementById('post-image-url').value.trim();

        if (!postContent && !postImage) {
            alert('üö® Por favor, escreva algo ou forne√ßa uma URL de imagem para publicar.');
            return;
        }

        const authorName = currentUser.teamName || currentUser.userName;
        const authorImage = currentUser.logo || currentUser.profilePic;

        const newPost = {
            author: authorName,
            content: postContent,
            date: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR'),
            image: postImage || null,
            authorPic: authorImage,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Timestamp para ordenar
        };

        try {
            await db.collection("posts").add(newPost);
            
            await loadDataFromFirebase(); 
            
            document.getElementById('post-input').value = '';
            document.getElementById('post-image-url').value = '';
            document.getElementById('image-preview').style.display = 'none';
            renderFeed();
            alert('‚úÖ Post publicado com sucesso!');

        } catch (e) {
            console.error("Erro ao publicar post:", e);
            alert("Erro ao publicar o post. Tente novamente.");
        }
    }

    // FUN√á√ÉO DELETAR POST (ADMIN)
    async function deletePost(postId) { 
        if (!loggedInUser || !usuariosCadastrados[loggedInUser].isAdmin) {
            alert('Acesso negado. Apenas o administrador pode excluir posts.');
            return;
        }
        if (confirm('Tem certeza que deseja excluir esta publica√ß√£o?')) {
            try {
                await db.collection("posts").doc(postId).delete();
                
                await loadDataFromFirebase();
                renderFeed();
                alert('Publica√ß√£o exclu√≠da.');
            } catch (e) {
                console.error("Erro ao deletar post:", e);
                alert('Erro ao excluir a publica√ß√£o.');
            }
        }
    }

    function renderFeed() {
        const feedContainer = document.getElementById('feed-posts');
        feedContainer.innerHTML = '';

        if (posts.length === 0) {
            feedContainer.innerHTML = '<p style="color:#ccc; text-align:center;">Nenhum post no feed ainda.</p>';
            return;
        }

        posts.forEach(post => {
            let imageHtml = post.image ? `<img src="${post.image}" alt="Imagem do Post" style="max-width:100%; height:auto; border-radius:8px; margin-top:10px;" onerror="this.style.display='none'"/>` : '';
            
            let adminDeleteBtn = '';
            if (loggedInUser && usuariosCadastrados[loggedInUser].isAdmin) {
                adminDeleteBtn = `<span style="color: #ff004c; font-size: 0.8em; margin-left: 15px; cursor: pointer;" onclick="deletePost('${post.id}')">Excluir</span>`;
            }
            
            const authorPic = post.authorPic || 'https://via.placeholder.com/30/06142e/00ff96?text=P';
            
            const dateDisplay = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleDateString('pt-BR') : post.date;

            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.innerHTML = `
                <div class="post-header" style="display: flex; align-items: center;">
                    <img src="${authorPic}" alt="Perfil" style="width: 30px; height: 30px; margin-right: 10px; border-radius: 50%; border: 1px solid #00ff96; object-fit: cover;">
                    <span class="post-author">${post.author}</span>
                    <span class="post-date">${dateDisplay}</span>
                    ${adminDeleteBtn} 
                </div>
                <div class="post-content">
                    ${(post.content || '').replace(/\n/g, '<br>')}
                    ${imageHtml}
                </div>
            `;
            feedContainer.appendChild(postElement);
        });
    }

    // --- Fun√ß√µes de Classifica√ß√£o (Mantidas) ---
    function sortTeams(a, b) {
        if (b.stats.Pontos !== a.stats.Pontos) return b.stats.Pontos - a.stats.Pontos;
        if (b.stats.Vit√≥rias !== a.stats.Vit√≥rias) return b.stats.Vit√≥rias - a.stats.Vit√≥rias;
        if (b.stats.Saldo !== a.stats.Saldo) return b.stats.Saldo - a.stats.Saldo;
        return b.stats.GolsPro - a.stats.GolsPro; 
    }
    
    function getAllTeams() {
        return Object.values(usuariosCadastrados).filter(user => user.teamName && !user.isAdmin);
    }

    function renderClassificationTables() {
        const teams = getAllTeams().filter(team => team.series);

        const serieA = teams.filter(t => t.series === 'S√©rie A').sort(sortTeams);
        const serieB = teams.filter(t => t.series === 'S√©rie B').sort(sortTeams);

        const renderTable = (tableBodyId, teams, statusId) => {
            const tableBody = document.querySelector(`#${tableBodyId} tbody`);
            const table = document.getElementById(tableBodyId);
            const status = document.getElementById(statusId);

            tableBody.innerHTML = '';

            if (teams.length === 0) {
                table.style.display = 'none';
                status.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            status.style.display = 'none';

            teams.forEach((team, index) => {
                const stats = team.stats;
                const row = tableBody.insertRow();
                
                row.insertCell().textContent = index + 1;
                
                const teamCell = row.insertCell();
                teamCell.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <img src="${team.logo}" alt="Logo" style="width: 25px; height: 25px; margin-right: 8px; border-radius: 50%; object-fit: cover;">
                        <a onclick="openPerfilTime('${team.username}')" class="team-link">${team.teamName}</a>
                    </div>
                `;
                teamCell.style.textAlign = 'left';

                row.insertCell().textContent = stats.Pontos || 0;
                row.insertCell().textContent = stats.Jogos || 0;
                row.insertCell().textContent = stats.Vit√≥rias || 0;
                row.insertCell().textContent = stats.Empates || 0;
                row.insertCell().textContent = stats.Derrotas || 0;
                row.insertCell().textContent = stats.GolsPro || 0;
                row.insertCell().textContent = stats.GolsContra || 0;
                row.insertCell().textContent = stats.Saldo || 0;
            });
        };

        renderTable('tabela-serie-a', serieA, 'series-a-status');
        renderTable('tabela-serie-b', serieB, 'series-b-status');
    }

    // --- Fun√ß√µes de Gest√£o Admin (Mantidas) ---
    
    function getAllAvailableTeams() {
        const allUsers = Object.values(usuariosCadastrados);
        const assignedTeamNames = allUsers
            .filter(user => user.teamName) 
            .map(user => user.teamName);
            
        const allBRTeams = Object.keys(teamData); 
        
        return allBRTeams.filter(teamName => !assignedTeamNames.includes(teamName));
    }

    function renderTeamsList() {
        const teamsList = document.getElementById('times-list');
        teamsList.innerHTML = '';
        const teams = getAllTeams().sort((a, b) => (a.teamName || '').localeCompare(b.teamName || ''));

        if (teams.length === 0) {
            teamsList.innerHTML = '<p>Nenhum time vinculado a um usu√°rio ainda.</p>';
            return;
        }

        teams.forEach(team => {
            const teamElement = document.createElement('div');
            teamElement.className = 'card';
            teamElement.style.cssText = 'padding: 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #0a1324; cursor: pointer;';
            teamElement.onclick = () => openPerfilTime(team.username);

            teamElement.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <img src="${team.logo}" alt="Logo" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 50%; object-fit: cover;">
                    <div>
                        <strong style="color: #00ff96;">${team.teamName}</strong>
                        <p style="margin: 0; font-size: 0.9em; color: #ccc;">S√©rie: ${team.series || 'Nenhuma'}</p>
                        <p style="margin: 0; font-size: 0.8em; color: #f2c94c;">Gerenciado por: ${team.userName}</p>
                    </div>
                </div>
                <span style="color: #f2c94c; font-weight: bold;">P: ${team.stats.Pontos || 0}</span>
            `;
            teamsList.appendChild(teamElement);
        });
    }

    function renderAdminTeamList() {
        const adminList = document.getElementById('admin-teams-list');
        adminList.innerHTML = '';
        const users = Object.keys(usuariosCadastrados)
            .filter(u => !usuariosCadastrados[u].isAdmin)
            .map(u => ({ username: u, ...usuariosCadastrados[u] }))
            .sort((a, b) => (a.userName || '').localeCompare(b.userName || ''));
        
        const availableTeams = getAllAvailableTeams();

        if (users.length === 0) {
            adminList.innerHTML = '<p style="color:#ccc;">N√£o h√° usu√°rios/times para gerenciar (apenas o administrador principal existe).</p>';
            return;
        }

        users.forEach(user => {
            const currentSeries = user.series || 'Nenhuma';
            const teamName = user.teamName || 'N√£o Vinculado';

            const teamElement = document.createElement('div');
            teamElement.style.cssText = 'background: #0a1324; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #00ff96; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;';

            let actionHtml = '';
            if (user.teamName) {
                actionHtml = `
                    <p style="margin: 5px 0 0; font-size: 0.9em; color: #00ff96;">Time: <b>${user.teamName} (${currentSeries})</b></p>
                    <div style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                        <button onclick="unlinkTeam('${user.username}')" style="background: #ff004c; color: #ffffff; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold;">Desvincular</button>
                        <button onclick="openTeamEditor('${user.username}')" style="background: #f2c94c; color: #050b16; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold;">Editar Usu√°rio/Time</button>
                    </div>
                `;
            } else {
                let selectOptions = availableTeams.map(name => `<option value="${name}">${name}</option>`).join('');
                actionHtml = `
                    <p style="margin: 5px 0 0; font-size: 0.9em; color: #ff004c;">Status: **N√ÉO VINCULADO**</p>
                    <div style="display: flex; gap: 8px; margin-top: 10px; align-items: center;">
                        <select id="select-team-${user.username}" style="padding: 5px; border-radius: 5px;">
                            <option value="">-- Vincular Time --</option>
                            ${selectOptions}
                        </select>
                        <button onclick="linkTeam('${user.username}')" style="background: #00ff96; color: #050b16; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold;">Vincular</button>
                    </div>
                `;
            }
            
            teamElement.innerHTML = `
                <div style="display: flex; align-items: center; width: 100%;">
                    <img src="${user.profilePic}" alt="Perfil" style="width: 40px; height: 40px; margin-right: 10px; border-radius: 50%; border: 2px solid #f2c94c; object-fit: cover;">
                    <div>
                        <strong style="color: #f2c94c;">${user.userName}</strong>
                        <p style="margin: 0; font-size: 0.8em; color: #ccc;">E-mail: ${user.email}</p>
                    </div>
                </div>
                <div style="width: 100%; margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px;">
                    ${actionHtml}
                    <button onclick="banUser('${user.username}', '${user.email}')" style="background: #000; color: #fff; border: 1px solid #ff004c; border-radius: 5px; padding: 6px 10px; cursor: pointer; font-size: 0.8em; font-weight: bold; margin-top: 10px;">Banir Usu√°rio</button>
                </div>
            `;
            adminList.appendChild(teamElement);
        });
    }

    async function banUser(username, email) { 
        if (!loggedInUser || !usuariosCadastrados[loggedInUser].isAdmin) return alert('Acesso negado.');

        const userToDelete = usuariosCadastrados[username];
        if (!userToDelete) return; 

        const userName = userToDelete.userName;
        

        if (confirm(`Tem certeza que deseja BANIR o usu√°rio ${userName} (${email})? Isso √© irrevers√≠vel. Todos os dados e posts ser√£o exclu√≠dos.`)) {
            try {
                await db.collection("users").doc(username).delete();

                delete usuariosCadastrados[username];

                await loadDataFromFirebase();
                
                renderAdminTeamList();
                renderTeamsList();
                renderFeed();
                alert(`Usu√°rio ${userName} e seus dados foram removidos do Firestore.`);

            } catch (e) {
                console.error("Erro ao banir usu√°rio:", e);
                alert("Erro ao banir o usu√°rio no Firestore. Verifique as regras de seguran√ßa.");
            }
        }
    }

    async function linkTeam(username) { 
        const selectElement = document.getElementById(`select-team-${username}`);
        const teamName = selectElement.value;
        
        if (!teamName) {
            return alert('Selecione um time para vincular.');
        }

        const teamDetails = teamData[teamName]; 
        const user = usuariosCadastrados[username];

        if (Object.values(usuariosCadastrados).some(u => u.teamName === teamName)) {
            return alert(`O time ${teamName} j√° est√° vinculado a outro usu√°rio.`);
        }

        // Vincula e Zera stats
        user.teamName = teamName;
        user.series = teamDetails.series;
        user.logo = teamDetails.logo;
        user.stats = defaultStats; 
        user.username = username; 

        // üö® Salva no Firebase
        await saveUsersToFirestore(username, user);
        
        renderAdminTeamList();
        renderClassificationTables();
        renderTeamsList();
        alert(`‚úÖ Time ${teamName} vinculado ao usu√°rio ${user.userName}.`);
    }

    async function unlinkTeam(username) { 
        if (!confirm('Tem certeza que deseja desvincular o time deste usu√°rio? O time ficar√° dispon√≠vel para ser vinculado novamente.')) {
            return;
        }
        const user = usuariosCadastrados[username];
        
        // Desvincula e Zera stats
        user.teamName = null;
        user.series = null;
        user.logo = null;
        user.stats = defaultStats; 
        
        await saveUsersToFirestore(username, user);
        
        renderAdminTeamList();
        renderClassificationTables();
        renderTeamsList();
        alert(`Time desvinculado de ${user.userName}.`);
    }

    function openTeamEditor(username) {
        const user = usuariosCadastrados[username];
        if (!user || user.isAdmin) return alert('Usu√°rio n√£o encontrado ou √© o administrador.');

        const newUserName = prompt(`Editar nome de exibi√ß√£o do usu√°rio "${user.userName}". Novo nome:`, user.userName);
        if (newUserName === null || newUserName.trim() === '') return;

        let currentPic = user.teamName ? user.logo : user.profilePic;
        let typeToEdit = user.teamName ? 'Logo do Time' : 'Foto de Perfil';
        const newPicUrl = prompt(`Editar URL da ${typeToEdit} de "${user.userName}". Nova URL:`, currentPic);
        if (newPicUrl === null) return;
        
        finalizeUserEdit(username, newUserName, newPicUrl);
    }

    async function finalizeUserEdit(username, newUserName, newPicUrl) { 
        const user = usuariosCadastrados[username];

        user.userName = newUserName;
        if (user.teamName) {
            user.logo = newPicUrl;
        } else {
            user.profilePic = newPicUrl;
        }
        
        await saveUsersToFirestore(username, user);
        
        await loadDataFromFirebase();

        renderAdminTeamList();
        renderTeamsList();
        renderClassificationTables();
        renderFeed();
        updateHeaderButtons(loggedInUser);
        alert(`Usu√°rio ${newUserName} atualizado com sucesso!`);
    }

    function populateTeamSelects(seriesFilter = null) {
        const time1Select = document.getElementById('jogo-time1');
        const time2Select = document.getElementById('jogo-time2');
        
        time1Select.innerHTML = '<option value="">-- Selecione --</option>';
        time2Select.innerHTML = '<option value="">-- Selecione --</option>';

        const teams = getAllTeams().filter(team => team.series === seriesFilter);

        teams.forEach(team => {
            const option1 = document.createElement('option');
            option1.value = team.username; 
            option1.textContent = team.teamName;
            time1Select.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = team.username;
            option2.textContent = team.teamName;
            time2Select.appendChild(option2);
        });
    }

    function filterTeamsBySeries(series) {
        if (series === 'S√©rie A' || series === 'S√©rie B') {
            populateTeamSelects(series);
        } else {
            populateTeamSelects(null);
        }
    }

    // FUN√á√ÉO REGISTRAR RESULTADO ATUALIZADA (AGORA SALVA NO FIREBASE)
    async function registrarResultado() { 
        const series = document.getElementById('jogo-series').value;
        const user1 = document.getElementById('jogo-time1').value; 
        const user2 = document.getElementById('jogo-time2').value; 
        const gols1 = parseInt(document.getElementById('jogo-gols1').value);
        const gols2 = parseInt(document.getElementById('jogo-gols2').value);

        if (!series || !user1 || !user2 || isNaN(gols1) || isNaN(gols2) || user1 === user2) {
            alert('üö® Por favor, preencha todos os campos corretamente (s√©rie, dois times diferentes e gols num√©ricos).');
            return;
        }
        
        if (usuariosCadastrados[user1].series !== series || usuariosCadastrados[user2].series !== series) {
            alert('üö® Erro: Um ou ambos os times n√£o est√£o alocados na S√©rie selecionada.');
            return;
        }

        const stats1 = usuariosCadastrados[user1].stats;
        const stats2 = usuariosCadastrados[user2].stats;

        // --- Atualiza Estat√≠sticas no Cache Local ---
        stats1.Jogos += 1;
        stats1.GolsPro += gols1;
        stats1.GolsContra += gols2;

        stats2.Jogos += 1;
        stats2.GolsPro += gols2;
        stats2.GolsContra += gols1;
        
        let pontos1 = 0;
        let pontos2 = 0;

        if (gols1 > gols2) { 
            pontos1 = 3;
            stats1.Vit√≥rias += 1;
            stats2.Derrotas += 1;
        } 
        else if (gols2 > gols1) { 
            pontos2 = 3;
            stats2.Vit√≥rias += 1;
            stats1.Derrotas += 1;
        } 
        else { 
            pontos1 = 1; 
            pontos2 = 1;
            stats1.Empates += 1;
            stats2.Empates += 1;
        }

        stats1.Pontos += pontos1;
        stats1.Saldo = stats1.GolsPro - stats1.GolsContra;

        stats2.Pontos += pontos2;
        stats2.Saldo = stats2.GolsPro - stats2.GolsContra;

        // üö® SALVA AMBOS OS TIMES NO FIREBASE
        await saveUsersToFirestore(user1, usuariosCadastrados[user1]);
        await saveUsersToFirestore(user2, usuariosCadastrados[user2]);
        
        renderClassificationTables();
        
        document.getElementById('jogo-gols1').value = '';
        document.getElementById('jogo-gols2').value = '';
        
        alert(`‚úÖ Resultado registrado! ${usuariosCadastrados[user1].teamName} ${gols1} x ${gols2} ${usuariosCadastrados[user2].teamName}. Classifica√ß√£o atualizada.`);
    }
    
    // --- Fun√ß√µes de Perfil (Mantidas) ---
    function openPerfilTime(username) {
        const perfilModal = document.getElementById('perfil-time');
        const team = usuariosCadastrados[username];

        if (!perfilModal || !team || !team.teamName) { alert(`Dados do time n√£o encontrados ou o usu√°rio n√£o est√° vinculado a um time.`); return; }

        document.getElementById('perfil-time-nome').textContent = team.teamName;
        document.getElementById('perfil-time-logo').src = team.logo || 'https://via.placeholder.com/130/06142e/00ff96?text=LOGO';
        document.getElementById('perfil-time-serie').textContent = team.series ? `S√©rie: ${team.series}` : 'S√©rie: Aguardando Aloca√ß√£o';
        document.getElementById('perfil-time-user-name').textContent = `Gerenciado por: ${team.userName}`;

        const stats = team.stats || defaultStats; 

        let statsHtml = `
            <table style="width:100%; text-align:left; background:none;">
                <tr><td style="width:50%; padding: 5px 0;">Pontos (P):</td><td style="padding: 5px 0;"><b>${stats.Pontos || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Jogos (J):</td><td style="padding: 5px 0;"><b>${stats.Jogos || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Vit√≥rias (V):</td><td style="padding: 5px 0;"><b>${stats.Vit√≥rias || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Empates (E):</td><td style="padding: 5px 0;"><b>${stats.Empates || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Derrotas (D):</td><td style="padding: 5px 0;"><b>${stats.Derrotas || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Gols Pr√≥ (GP):</td><td style="padding: 5px 0;"><b>${stats.GolsPro || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Gols Contra (GC):</td><td style="padding: 5px 0;"><b>${stats.GolsContra || 0}</b></td></tr>
                <tr><td style="width:50%; padding: 5px 0;">Saldo de Gols (SG):</td><td style="padding: 5px 0;"><b>${stats.Saldo || 0}</b></td></tr>
            </table>
        `;
        document.getElementById('perfil-time-stats').innerHTML = statsHtml;

        const teamPosts = posts.filter(post => post.author === team.teamName);
        let feedHtml = '';
        if (teamPosts.length > 0) {
            feedHtml = teamPosts.map(post => {
                let img = post.image ? `<img src="${post.image}" style="max-width:100%; height:auto; border-radius:5px; margin-top:10px;" onerror="this.style.display='none'"/>` : '';
                const dateDisplay = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleDateString('pt-BR') : post.date;
                return `<div style="background:#0a1324; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.1);"><p style="font-size:0.9em;">${post.content}</p>${img}<p style="font-size:0.7em; color:#999; text-align:right;">${dateDisplay}</p></div>`;
            }).join('');
        } else {
            feedHtml = '<p style="color:#999;">Nenhum post recente deste time.</p>';
        }
        document.getElementById('perfil-time-feed').innerHTML = feedHtml;

        perfilModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }


</script>
</body>
</html>
