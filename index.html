<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SUPERLIGA BRASILEIRA - Vers√£o Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* [Se√ß√£o de Estilos CSS] */
        body { margin: 0; font-family: 'Roboto', sans-serif; background: #050b16; color: #ffffff; line-height: 1.6; }
        
        /* 1. Header e Logo */
        header { text-align: center; padding: 40px 20px 60px; background: linear-gradient(180deg, #06142e, #050b16); border-bottom: 3px solid #00ff96; }
        .logo { width: 180px; filter: drop-shadow(0 0 15px #00ff96); } 
        h1 { margin-top: 15px; font-size: 2.8rem; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 15px #00ff96; color: #ffffff; }
        
        /* 2. Bot√µes Principais */
        .header-btn { 
            margin-top: 20px; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.3s, box-shadow 0.3s;
            margin-left: 10px;
        }
        #header-login-button { 
            background: #f2c94c; 
            color: #050b16; 
            box-shadow: 0 0 10px #f2c94c; 
        }
        #admin-panel-button {
            background: #ff004c; 
            color: #ffffff; 
            box-shadow: 0 0 10px #ff004c;
        }
        #admin-panel-button:hover, #header-login-button:hover { 
            filter: brightness(1.2); 
        }

        /* 3. Navega√ß√£o */
        nav { display: flex; justify-content: center; gap: 40px; padding: 20px; background: #06142e; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #00ff96; }
        nav a { color: #00ff96; text-decoration: none; font-size: 1.2rem; font-weight: bold; transition: 0.3s ease-in-out; padding: 5px 10px; border-radius: 5px; }
        nav a:hover { color: #f2c94c; text-shadow: 0 0 10px #f2c94c; transform: scale(1.05); background: rgba(242, 201, 76, 0.1); }
        
        /* 4. Layout Geral */
        .container { width: 90%; max-width: 1200px; margin: 30px auto; padding: 0 10px; }
        .card { 
            background: rgba(255,255,255,0.08); 
            border: 1px solid rgba(0,255,150,0.5); 
            padding: 25px; 
            border-radius: 16px; 
            margin-bottom: 35px; 
            box-shadow: 0 0 15px rgba(0,255,150,0.3); 
        }
        .title { 
            font-size: 2rem; 
            margin-bottom: 20px; 
            color: #00ff96; 
            text-shadow: 0 0 10px #00ff96; 
            border-bottom: 2px dashed rgba(0,255,150,0.4); 
            padding-bottom: 10px; 
        }
        .action-button { 
            background: #00ff96; 
            color: #050b16; 
            border: none; 
            border-radius: 8px; 
            padding: 12px 20px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.3s; 
            box-shadow: 0 0 10px rgba(0,255,150,0.5); 
            width: 100%; 
        }
        .action-button:hover { background: #f2c94c; box-shadow: 0 0 15px #f2c94c; }
        .link-switch { color:#f2c94c; text-decoration:none; cursor: pointer; font-weight: bold; transition: color 0.2s; }

        /* 5. Tabelas */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 1.05rem; }
        th, td { padding: 15px 5px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.15); }
        th { background: rgba(0,255,150,0.25); color: #ffffff; font-size: 0.95rem; text-transform: uppercase; }
        tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        tr:hover { background: rgba(0,255,150,0.1); cursor: pointer; }
        .team-link { cursor: pointer; color: #f2c94c; font-weight: bold; text-shadow: 0 0 3px #f2c94c; transition: color 0.2s; }
        
        /* Regras de Classifica√ß√£o */
        .serie-a tbody tr:nth-child(-n+6) { background: rgba(0, 150, 255, 0.2); } 
        .serie-a tbody tr:nth-child(n+17) { background: rgba(255, 0, 76, 0.25); font-weight: bold; } 
        .serie-b tbody tr:nth-child(-n+4) { background: rgba(0, 255, 150, 0.25); font-weight: bold; } 
        .serie-b tbody tr:nth-child(n+17) { background: rgba(255, 0, 76, 0.25); } 
        
        /* 6. Feed e Posts */
        .post { background: #0a1324; border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .post-author { font-weight: bold; color: #00ff96; margin-right: 10px; }
        .post-date { font-size: 0.8em; color: #999; }
        .post-content { color: #ccc; }
        #post-form-container textarea { 
            width: 96%; 
            padding: 10px; 
            background: #0a1324; 
            border: 1px solid #00ff96; 
            border-radius: 8px; 
            color: white; 
            resize: vertical; 
            min-height: 80px; 
        }
        
        /* 7. Modais (Login/Cadastro/Admin) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background: rgba(5, 11, 22, 0.95); z-index: 9999; padding-bottom: 60px; backdrop-filter: blur(5px); }
        .login-box { background:rgba(255,255,255,0.05); border:1px solid #00ff96; width:85%; max-width:420px; margin:auto; padding:35px; border-radius:14px; box-shadow:0 0 25px rgba(0,255,150,0.4); }
        .login-input { width:90%; padding:15px; background:#0a1324; border:1px solid #00ff96; border-radius:8px; color:white; margin-bottom:20px; font-size: 1rem; }
        .modal-content { width: 90%; max-width: 900px; margin: 20px auto; }
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 25px; 
            font-size: 30px; 
            font-weight: bold; 
            color: #ff004c; 
            cursor: pointer;
            text-decoration: none;
            line-height: 1;
            transition: color 0.2s;
        }
        .close-btn:hover { color: #ffffff; }

        /* Estilo espec√≠fico do modal de Perfil do Time */
        #perfil-time .modal-header {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg,#00ff96,#06142e);
            box-shadow: 0 0 30px #00ff96;
            position: relative;
            text-align: center;
            padding-top: 40px;
            margin-bottom: 0;
        }
        #perfil-time .modal-content { margin-top: -50px; } /* Ajusta o conte√∫do para cobrir o header */
        
    </style>
</head>
<body>
    <header>
        <img src="https://i.imgur.com/vHq8qH7.png" class="logo" alt="Logo Superliga" /> 
        <h1>SUPERLIGA BRASILEIRA</h1>
        
        <button onclick="openLogin()" id="header-login-button" class="header-btn">
            ACESSAR CONTA
        </button>
        <button onclick="fazerLogout()" id="admin-panel-button" class="header-btn" style="display:none;">
            LOGOUT
        </button>
    </header>

    <nav>
        <a href="#feed">Feed</a>
        <a href="#series">S√©ries A e B</a>
        <a href="#times">Times Vinculados</a>
        <a href="#" onclick="openLogin()">Login/Cadastro</a>
    </nav>

    <div class="container" id="feed">
        <div class="card">
            <div class="title">üì∏ Feed Oficial</div>

            <div id="post-form-container" style="display:none; margin-bottom: 30px; padding: 15px; background: #06142e; border-radius: 10px; border: 1px solid #f2c94c;">
                <h3 style="color:#f2c94c;">O que est√° acontecendo na Superliga? (Max: 500 caracteres)</h3>
                <textarea id="post-input" placeholder="Publique uma not√≠cia, atualiza√ß√£o ou mensagem..." maxlength="500"></textarea>
                
                <input type="url" id="post-image-url" 
                        placeholder="URL da Imagem (opcional)" 
                        class="login-input" 
                        style="width: 96%; margin-top: 10px;"
                        oninput="showImagePreview(this.value)" 
                />
                
                <img id="image-preview" src="" alt="Pr√©via da Imagem" style="display:none; max-width: 96%; height: auto; margin-top: 10px; border-radius: 5px; border: 2px solid #f2c94c;">
                
                <button onclick="publishPost()" class="action-button" style="width: auto; padding: 10px 20px; margin-top: 10px;">Publicar</button>
            </div>

            <div id="feed-posts">
                <p>Carregando Feed...</p>
            </div>
        </div>
    </div>

    <div class="container" id="series">
        <div class="card">
            <div class="title">üèÜ S√©rie A ‚Äî Classifica√ß√£o</div>
            <p id="series-a-status">Carregando dados...</p>
            <table id="tabela-serie-a" class="serie-a" style="display:none;">
                <thead><tr><th>#</th><th>Time</th><th>P</th><th>J</th><th>V</th><th>E</th><th>D</th><th>GP</th><th>GC</th><th>SG</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="card">
            <div class="title">üí† S√©rie B ‚Äî Classifica√ß√£o</div>
            <p id="series-b-status">Carregando dados...</p>
            <table id="tabela-serie-b" class="serie-b" style="display:none;">
                <thead><tr><th>#</th><th>Time</th><th>P</th><th>J</th><th>V</th><th>E</th><th>D</th><th>GP</th><th>GC</th><th>SG</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="container" id="times">
        <div class="card">
            <div class="title">üõ°Ô∏è Times Vinculados</div>
            <div id="times-list">
                <p>Carregando times...</p>
            </div>
        </div>
    </div>

    <footer>
        <div style="text-align: center; padding: 20px; color: #999; border-top: 1px solid rgba(0,255,150,0.2);">
            SUPERLIGA ¬© 2025 ‚Äî O Campeonato Futurista do Brasil
        </div>
    </footer>

<div id="perfil-time" class="modal">
    <div class="modal-header">
        <img id="perfil-time-logo" src="" class="modal-logo" alt="Logo do Time" style="width: 130px; height: 130px; filter: drop-shadow(0 0 10px #000); border-radius: 50%; border: 5px solid #fff; object-fit: cover;"/>
        <h2 id="perfil-time-nome" style="margin-top:15px; font-size:2rem; color:white; text-shadow:0 0 10px #000;"></h2>
        <p id="perfil-time-serie" style="color:#f2c94c; font-weight: bold;"></p>
        <p id="perfil-time-user-name" style="color:#00ff96; font-size: 0.9em;"></p>
        <button onclick="closePerfilTime()" class="close-btn" style="color:white; right: 15px; top: 5px;">X</button>
    </div>

    <div class="modal-content">
        <div class="card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 14px; border: 1px solid #00ff96; margin-bottom: 25px; box-shadow: 0 0 10px rgba(0,255,150,0.5);">
            <h3 class="title" style="color:#00ff96; margin-bottom: 15px; text-shadow: 0 0 8px #00ff96; border-bottom: 1px solid rgba(0,255,150,0.5); padding-bottom: 10px; font-size: 1.5rem;">üìä Estat√≠sticas</h3>
            <div id="perfil-time-stats">Nenhuma estat√≠stica dispon√≠vel.</div>
        </div>

        <div class="card" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 14px; border: 1px solid #00ff96; margin-bottom: 25px; box-shadow: 0 0 10px rgba(0,255,150,0.5);">
            <h3 class="title" style="color:#00ff96; margin-bottom: 15px; text-shadow: 0 0 8px #00ff96; border-bottom: 1px solid rgba(0,255,150,0.5); padding-bottom: 10px; font-size: 1.5rem;">üì∞ Posts Recentes</h3>
            <div id="perfil-time-feed">Nenhum post deste time.</div>
        </div>

        <button onclick="closePerfilTime()" class="action-button">Voltar √† Liga</button>
    </div>
</div>

<div id="login" class="modal" style="padding-top:120px; text-align:center;">
    <div class="login-box">
        <img src="https://i.imgur.com/vHq8qH7.png" style="width:140px; filter:drop-shadow(0 0 10px #00ff96); margin-bottom:20px;" alt="Logo Superliga" />
        <h2 style="color:#00ff96; text-shadow:0 0 10px #00ff96; margin-bottom:25px;">ACESSO DE MEMBRO</h2>
        <input type="email" placeholder="E-mail" id="login-email" class="login-input" />
        <input type="password" placeholder="Senha" id="login-pass" class="login-input" />
        <button onclick="fazerLogin()" class="action-button">ENTRAR</button>
        <p style="font-size:0.9rem; margin-top:20px; color: #ccc;">
            Ainda n√£o tem conta? <a class="link-switch" onclick="openRegister()">Cadastre-se aqui</a>.
        </p>
        <button onclick="closeLogin()" class="header-btn" style="background: transparent; border: 1px solid #00ff96; color: #00ff96; width: 100%; margin: 15px 0 0 0;">
            Cancelar
        </button>
    </div>
</div>

<div id="register" class="modal" style="padding-top:120px; text-align:center;">
    <div class="login-box">
        <img src="https://i.imgur.com/vHq8qH7.png" style="width:140px; filter:drop-shadow(0 0 10px #00ff96); margin-bottom:20px;" alt="Logo Superliga" />
        <h2 style="color:#00ff96; text-shadow:0 0 10px #00ff96; margin-bottom:25px;">CADASTRO DE NOVO MEMBRO</h2>
        
        <input type="url" placeholder="URL da Foto de Perfil (Opcional)" id="register-profile-pic" class="login-input" />
        
        <input type="text" placeholder="Nome de Usu√°rio (Ser√° seu nome no feed)" id="register-user" class="login-input" />
        <input type="email" placeholder="E-mail do Membro (Obrigat√≥rio)" id="register-email" class="login-input" />
        <input type="password" placeholder="Senha (M√≠nimo 6 caracteres)" id="register-pass" class="login-input" />
        <button onclick="fazerCadastro()" class="action-button">CADASTRAR MEMBRO</button>
        <p style="font-size:0.9rem; margin-top:20px; color: #ccc;">
            J√° √© membro? <a class="link-switch" onclick="openLogin()">Voltar ao Login</a>.
        </p>
        <button onclick="closeRegister()" class="header-btn" style="background: transparent; border: 1px solid #00ff96; color: #00ff96; width: 100%; margin: 15px 0 0 0;">
            Cancelar
        </button>
    </div>
</div>

<div id="admin-panel" class="modal" style="padding-top:60px;">
    <div class="modal-content">
        <a href="#" onclick="fecharPainelAdmin()" class="close-btn">X</a> 

        <div class="card" style="margin-bottom: 25px; position: relative;">
            <h2 class="title" style="border-color: #ff004c;">‚öΩ REGISTRAR NOVO JOGO</h2>
            <p style="color: #ccc; margin-bottom: 15px;">Insira o placar da partida para atualizar as classifica√ß√µes.</p>

            <label style="display:block; margin-bottom: 5px; color:#00ff96;">S√©rie da Partida:</label>
            <select id="jogo-series" class="login-input" style="width:100%;" onchange="filterTeamsBySeries(this.value)">
                <option value="">-- Selecione a S√©rie --</option>
                <option value="S√©rie A">S√©rie A</option>
                <option value="S√©rie B">S√©rie B</option>
            </select>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <div style="width: 45%;">
                    <label style="display:block; margin-bottom: 5px; color:#f2c94c;">Time 1 (Casa):</label>
                    <select id="jogo-time1" class="login-input" style="width:100%;"></select>
                    <input type="number" id="jogo-gols1" placeholder="Gols Time 1" class="login-input" min="0" style="width:90%;" />
                </div>

                <div style="width: 10%; text-align: center; font-size: 1.5rem; color:#ff004c; font-weight: bold;">VS</div>

                <div style="width: 45%;">
                    <label style="display:block; margin-bottom: 5px; color:#f2c94c;">Time 2 (Visitante):</label>
                    <select id="jogo-time2" class="login-input" style="width:100%;"></select>
                    <input type="number" id="jogo-gols2" placeholder="Gols Time 2" class="login-input" min="0" style="width:90%;" />
                </div>
            </div>

            <button onclick="registrarResultado()" class="action-button" style="background: #ff004c; margin-top: 20px;">
                CALCULAR E REGISTRAR
            </button>
        </div>
        
        <div class="card">
            <h2 class="title" style="border-color: #ff004c;">üë• GEST√ÉO E VINCULA√á√ÉO DE MEMBROS</h2>
            <p style="color: #ff004c; font-weight: bold;">Vincule usu√°rios aos times das S√©ries A e B.</p>
            <div id="admin-teams-list">
                </div>
            <button onclick="fecharPainelAdmin()" class="action-button" style="background: #ff004c;">Fechar Painel</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // ** CONFIGURA√á√ÉO DO FIREBASE **
    const firebaseConfig = {
        // MANTENDO A CONFIGURA√á√ÉO QUE VOC√ä ESTAVA USANDO
        apiKey: "AIzaSyAJoUwJY_EQ0LJ4g-Fvri07hDSL96qul7s",
        authDomain: "super-liga-brasileira.firebaseapp.com",
        projectId: "super-liga-brasileira",
        storageBucket: "super-liga-brasileira.firebasestorage.app",
        messagingSenderId: "178822052518",
        appId: "1:178822052518:web:1cf7c353285bf51f2d1267",
        measurementId: "G-9G6409TNJG"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Cole√ß√µes
    const usersCollection = db.collection('users');
    const postsCollection = db.collection('posts');
    const logsCollection = db.collection('logs'); 

    // Vari√°veis de Cache e Estado
    let allUsersCache = [];
    let allPostsCache = [];
    let loggedInUserUID = null; 
    let loggedInUserObject = null;

    // Objeto padr√£o para estat√≠sticas (usado para zerar ou em times sem dados)
    const defaultStats = { Pontos: 0, Jogos: 0, Vit√≥rias: 0, Empates: 0, Derrotas: 0, GolsPro: 0, GolsContra: 0, Saldo: 0 };


    // --- Data dos Times (Mantido com seus logos e s√©ries) ---
    const teamData = {
        'Atl√©tico-GO': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/4/4e/Atl√©tico_Clube_Goianiense_-_Escudo.png' },
        'Atl√©tico-MG': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/2/22/Clube_Atl√©tico_Mineiro_-_Escudo.png' },
        'Athletico-PR': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/2/23/Clube_Athletico-Paranaense_2020.png' },
        'Bahia': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/1/1d/Esporte_Clube_Bahia.png' },
        'Botafogo': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/2/26/Botafogo_de_Futebol_e_Regatas_logo.svg' },
        'Corinthians': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b3/Corinthians_logo.png' },
        'Crici√∫ma': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/1/1a/Crici√∫ma_Esporte_Clube.png' },
        'Cruzeiro': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/9/9f/CruzeiroEsporteClube.png' },
        'Cuiab√°': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/thumb/d/d5/Cuiab%C3%A1_Esporte_Clube_-_Escudo.png/50px-Cuiab%C3%A1_Esporte_Clube_-_Escudo.png' },
        'Flamengo': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/9/93/Flamengo-RJ_%28BRA%29.png' },
        'Fluminense': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/a/a2/Fluminense_FC_escudo.png' },
        'Fortaleza': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/4/43/Fortaleza_Esporte_Clube_novo_logo.png' },
        'Gr√™mio': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b3/Gremio_logo.png' },
        'Internacional': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/f/f1/Escudo_do_Sport_Club_Internacional.svg' },
        'Juventude': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/3/36/Juventude_logo.png' },
        'Palmeiras': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/1/10/Palmeiras_logo.svg' },
        'Red Bull Bragantino': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/5/50/Red_Bull_Bragantino_escudo.png' },
        'S√£o Paulo': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/pt/4/4f/S%C3%A3o_Paulo_Futebol_Clube.png' },
        'Vasco': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/d/df/Escudo_do_Club_de_Regatas_Vasco_da_Gama.svg' },
        'Vit√≥ria': { series: 'S√©rie A', logo: 'https://upload.wikimedia.org/wikipedia/commons/6/6f/EC_Vit√≥ria_-_Ba.png' },
        'Am√©rica-MG': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/1/1a/Am%C3%A9rica_Futebol_Clube_logo.svg' },
        'Ava√≠': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/5/54/Ava%C3%AD_Futebol_Clube.png' },
        'Botafogo-SP': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/8/87/Botafogo-SP.png' },
        'Brusque': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/c/c5/Brusque_FC.png' },
        'Cear√°': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/f/fc/Ceara_SC.png' },
        'Chapecoense': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/a/a2/Associa%C3%A7%C3%A3o_Chapecoense_de_Futebol.png' },
        'CRB': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b0/Clube_de_Regatas_Brasil.png' },
        'Goi√°s': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/5/52/Goi%C3%A1s_Esporte_Clube.png' },
        'Guarani': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/2/2d/Guarani-SP.png' },
        'Ituano': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/0/07/Ituano_Futebol_Clube.png' },
        'Novorizontino': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/1/11/Gr%C3%AAmio_Novorizontino.png' },
        'Oper√°rio-PR': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/8/8f/Oper%C3%A1rio_Ferrovi%C3%A1rio_Esporte_Clube.png' },
        'Paysandu': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/commons/8/8e/Escudo_Paysandu.png' },
        'Ponte Preta': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/7/7b/Aapp_escudo.png' },
        'Santos': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/b/b1/Santos_FC_logo.png' },
        'Sport': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/e/eb/Sport_Club_do_Recife.png' },
        'Vila Nova': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/d/d4/Vila_Nova_Futebol_Clube.png' },
        'Amazonas': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/thumb/d/d4/Amazonas_FC_logo.png/50px-Amazonas_FC_logo.png' },
        'Mirassol': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/c/c5/Mirassol_Futebol_Clube.png' },
        'Remo': { series: 'S√©rie B', logo: 'https://upload.wikimedia.org/wikipedia/pt/thumb/4/4b/Clube_do_Remo.svg/50px-Clube_do_Remo.svg.png' },
    };


    // --- Event Listener de Carregamento Principal ---
    document.addEventListener('DOMContentLoaded', () => {
        // Observa o estado de autentica√ß√£o do Firebase
        auth.onAuthStateChanged(user => {
            if (user) {
                // Usu√°rio logado via Auth, busca os dados no Firestore
                fetchUserObject(user.uid);
            } else {
                // Usu√°rio deslogado
                loggedInUserUID = null;
                loggedInUserObject = null;
                updateHeaderButtons(null);
                // Mesmo deslogado, renderiza os dados p√∫blicos (classifica√ß√£o e feed)
                renderAllData(); 
            }
        });
        
        // Listener para carregar dados do Firestore em tempo real
        setupFirestoreListeners();
    });
    
    // --- Fun√ß√µes de Sincroniza√ß√£o e Cache ---

    function setupFirestoreListeners() {
        // 1. Ouvir mudan√ßas na cole√ß√£o 'users'
        // ESSA FUN√á√ÉO FOI RESTAURADA PARA O MODELO QUE FUNCIONA PARA CARREGAR OS DADOS
        usersCollection.onSnapshot(snapshot => {
            allUsersCache = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            
            // Se o usu√°rio logado estava no cache, atualiza o objeto logado
            if (loggedInUserUID) {
                 loggedInUserObject = allUsersCache.find(u => u.uid === loggedInUserUID);
            }
            
            // Renderiza tudo (mesmo se o usu√°rio estiver deslogado, para carregar tabelas e times)
            renderAllData(); 
        }, err => {
            console.error("Erro ao receber dados dos usu√°rios:", err);
            // Mensagem de erro que aponta para as regras de seguran√ßa
            document.getElementById('series-a-status').textContent = "‚ö†Ô∏è ERRO DE LEITURA. Verifique as Regras de Seguran√ßa do Firestore para a cole√ß√£o 'users'.";
            document.getElementById('series-b-status').textContent = "‚ö†Ô∏è ERRO DE LEITURA. Verifique as Regras de Seguran√ßa do Firestore para a cole√ß√£o 'users'.";
        });
        
        // 2. Ouvir mudan√ßas na cole√ß√£o 'posts'
        postsCollection.orderBy('timestamp', 'desc').limit(50).onSnapshot(snapshot => {
            allPostsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFeed();
        }, err => {
            console.error("Erro ao receber dados dos posts:", err);
            document.getElementById('feed-posts').innerHTML = '<p style="color:red; text-align:center;">‚ö†Ô∏è ERRO AO CARREGAR O FEED. Verifique as Regras de Seguran√ßa do Firestore para a cole√ß√£o \'posts\'.</p>';
        });
    }
    
    function renderAllData() {
        renderClassificationTables();
        renderTeamsList();
        if(loggedInUserObject && loggedInUserObject.isAdmin) {
             renderAdminTeamList(); // Atualiza a gest√£o no painel admin se aberto
        }
        updateHeaderButtons(loggedInUserObject); // Redraw buttons/display name
    }

    // --- Fun√ß√µes Auxiliares de Dados ---

    async function fetchUserObject(uid) {
        // Esta fun√ß√£o foi reescrita para ser mais simples e menos propensa a erros de 'dados incompletos'
        try {
            const doc = await usersCollection.doc(uid).get();
            if (doc.exists) {
                loggedInUserUID = uid;
                loggedInUserObject = { uid: uid, ...doc.data() };
                updateHeaderButtons(loggedInUserObject);
                renderAllData(); 
                
                // L√≥gica de Confirma√ß√£o de ADM (Robben Anthony)
                if (loggedInUserObject.email === 'robbenanthony12@gmail.com' && !loggedInUserObject.isAdmin) {
                    await usersCollection.doc(uid).update({ isAdmin: true, userName: 'Robben Anthony (ADMIN)' });
                    loggedInUserObject.isAdmin = true;
                    loggedInUserObject.userName = 'Robben Anthony (ADMIN)';
                    updateHeaderButtons(loggedInUserObject);
                    alert("Bem-vindo, Administrador principal! Seu status foi confirmado.");
                } else {
                     alert(`‚úÖ Login bem-sucedido! Bem-vindo(a), ${loggedInUserObject.userName || loggedInUserObject.teamName || 'Membro'}.`);
                }
            } else {
                console.warn("Usu√°rio autenticado, mas dados n√£o encontrados no Firestore. UID:", uid);
                // Se o usu√°rio existe no Auth mas n√£o no Firestore, for√ßamos o logout para evitar loops.
                await auth.signOut();
            }
        } catch (error) {
            console.error("Erro ao buscar objeto do usu√°rio:", error);
            alert("‚ùå Falha cr√≠tica no login. Verifique as Regras de Seguran√ßa do Firestore. Detalhes: " + error.message);
        }
    }


    // --- Fun√ß√µes de Modais e Navega√ß√£o ---
    function openLogin() { document.getElementById('register').style.display = 'none'; document.getElementById('login').style.display = 'block'; document.body.style.overflow = 'hidden'; }
    function closeLogin() { document.getElementById('login').style.display = 'none'; document.body.style.overflow = 'auto'; }
    function openRegister() { document.getElementById('login').style.display = 'none'; document.getElementById('register').style.display = 'block'; document.body.style.overflow = 'hidden'; }
    function closeRegister() { document.getElementById('register').style.display = 'none'; document.body.style.overflow = 'auto'; }
    function closePerfilTime() { document.getElementById('perfil-time').style.display = 'none'; document.body.style.overflow = 'auto'; }
    
    function fecharPainelAdmin() {
        document.getElementById('admin-panel').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    function openAdminPanel() {
        if (!loggedInUserObject || !loggedInUserObject.isAdmin) { alert('Acesso negado.'); return; }
        renderAdminTeamList();
        filterTeamsBySeries(''); 
        document.getElementById('admin-panel').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }


    // --- Fun√ß√µes de Login e Cadastro (ONLINE) ---
    function updateHeaderButtons(user) {
        const loginBtn = document.getElementById('header-login-button');
        const adminBtn = document.getElementById('admin-panel-button');
        const postForm = document.getElementById('post-form-container');
        
        if (user) {
            const displayName = user.userName || user.teamName || user.email;

            if (user.isAdmin) {
                // Se for ADM, o bot√£o principal vira PAINEL e o segundo vira LOGOUT
                loginBtn.textContent = `PAINEL ADMIN (${displayName})`;
                loginBtn.onclick = openAdminPanel; 
                loginBtn.style.background = '#ff004c'; 
                
                adminBtn.onclick = fazerLogout;
                adminBtn.textContent = `LOGOUT`;
                adminBtn.style.background = '#f2c94c';
                adminBtn.style.display = 'inline-block';
            } else {
                // Se for usu√°rio normal, s√≥ tem o bot√£o de LOGOUT
                loginBtn.textContent = `LOGOUT (${displayName})`;
                loginBtn.onclick = fazerLogout;
                loginBtn.style.background = '#f2c94c';
                adminBtn.style.display = 'none';
            }
            
            postForm.style.display = 'block';
        } else {
            // Deslogado
            loginBtn.textContent = 'ACESSAR CONTA';
            loginBtn.onclick = openLogin;
            adminBtn.style.display = 'none';
            postForm.style.display = 'none';
            loginBtn.style.background = '#f2c94c';
        }
    }

    async function fazerLogin() { 
        const email = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value.trim();

        if (!email || !pass) {
            alert('Preencha o e-mail e a senha.');
            return;
        }

        try {
            await auth.signInWithEmailAndPassword(email, pass);
            closeLogin();
        } catch (error) {
             let message = '‚ùå Erro desconhecido no Login.';
            if (error.code === 'auth/user-not-found') {
                message = '‚ùå E-mail n√£o cadastrado.';
            } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = '‚ùå Senha incorreta.';
            } else if (error.code === 'auth/invalid-email') {
                message = '‚ùå E-mail inv√°lido.';
            } else if (error.code === 'auth/invalid-login-credentials') {
                 message = '‚ùå Falha no login. Verifique o e-mail e a senha.';
            } else {
                message += ` [${error.code}]`;
            }
            alert(message);
        }
    }

    async function fazerLogout() {
        try {
            await auth.signOut();
            alert('Voc√™ foi desconectado(a) com sucesso.');
        } catch (error) {
            console.error("Erro ao fazer logout:", error);
            alert('‚ùå Falha ao tentar desconectar.');
        }
    }

    async function fazerCadastro() { 
        const profilePicUrl = document.getElementById('register-profile-pic').value.trim(); 
        const user = document.getElementById('register-user').value.trim(); 
        const email = document.getElementById('register-email').value.trim();
        const pass = document.getElementById('register-pass').value.trim();

        if (!user || !email || !pass || pass.length < 6) {
            alert('üö® Por favor, preencha o Nome de Usu√°rio, E-mail, e use uma senha de no m√≠nimo 6 caracteres.');
            return;
        }
        
        try {
            // 1. Cria o usu√°rio no Firebase Authentication
            const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
            const uid = userCredential.user.uid;

            // 2. Cria o objeto do usu√°rio no Firestore
            const newUserObject = {
                email: email,
                isAdmin: false,
                userName: user,
                profilePic: profilePicUrl || 'https://i.imgur.com/G4fB8hL.png', // Imagem de perfil padr√£o
                teamId: null, // Usu√°rio come√ßa sem time vinculado
                teamName: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await usersCollection.doc(uid).set(newUserObject);

            alert('‚úÖ Cadastro realizado com sucesso! Voc√™ ser√° logado(a) automaticamente.');
            closeRegister();
        } catch (error) {
            console.error("Erro no cadastro:", error);
            let message = '‚ùå Erro desconhecido no Cadastro.';
            if (error.code === 'auth/email-already-in-use') {
                message = '‚ùå E-mail j√° cadastrado.';
            } else if (error.code === 'auth/weak-password') {
                message = '‚ùå Senha muito fraca. Use 6 ou mais caracteres.';
            }
            alert(message);
        }
    }

    // --- Fun√ß√µes do Feed de Not√≠cias ---
    
    function showImagePreview(url) {
        const preview = document.getElementById('image-preview');
        // Usamos uma valida√ß√£o b√°sica para exibir a preview.
        if (url && (url.startsWith('http') || url.startsWith('https'))) { 
            preview.src = url;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    async function publishPost() {
        const content = document.getElementById('post-input').value.trim();
        const imageUrl = document.getElementById('post-image-url').value.trim();

        if (!loggedInUserObject || !loggedInUserUID) {
            alert('Voc√™ precisa estar logado para publicar.');
            return;
        }

        if (!content) {
            alert('A postagem n√£o pode ser vazia.');
            return;
        }
        
        // NOVO LIMITE: 500 CARACTERES
        if (content.length > 500) { 
            alert('A postagem n√£o pode ter mais de 500 caracteres.');
            return;
        }

        try {
            await postsCollection.add({
                authorId: loggedInUserUID,
                authorName: loggedInUserObject.userName || loggedInUserObject.email,
                content: content,
                imageUrl: imageUrl || null,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            document.getElementById('post-input').value = '';
            document.getElementById('post-image-url').value = '';
            showImagePreview('');
            alert('Postagem publicada com sucesso!');
        } catch (error) {
            console.error("Erro ao publicar post:", error);
            alert("‚ùå Falha ao publicar post. Verifique as regras de escrita do Firestore.");
        }
    }

    function renderFeed() {
        const feedContainer = document.getElementById('feed-posts');
        feedContainer.innerHTML = '';
        
        if (allPostsCache.length === 0) {
            feedContainer.innerHTML = '<p style="color:#ccc; text-align:center;">Nenhuma not√≠cia ou postagem ainda. Seja o primeiro a publicar!</p>';
            return;
        }

        allPostsCache.forEach(post => {
            const author = allUsersCache.find(u => u.uid === post.authorId) || { userName: post.authorName || 'Membro Desconhecido' };
            
            let dateStr = 'H√° pouco tempo';
            if (post.timestamp && post.timestamp.toDate) {
                dateStr = post.timestamp.toDate().toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            }
            
            // Verifica√ß√£o de URL para garantir que a imagem n√£o tente carregar algo inv√°lido
            const isValidImageUrl = post.imageUrl && (post.imageUrl.startsWith('http') || post.imageUrl.startsWith('https'));

            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.innerHTML = `
                <div class="post-header">
                    <img src="${author.profilePic || 'https://i.imgur.com/G4fB8hL.png'}" alt="Foto de Perfil" style="width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; object-fit: cover; border: 2px solid ${author.isAdmin ? '#ff004c' : '#00ff96'};">
                    <span class="post-author">${author.userName || author.email} ${author.isAdmin ? '(ADMIN)' : ''}</span>
                    <span class="post-date"> - ${dateStr}</span>
                </div>
                ${isValidImageUrl ? `<img src="${post.imageUrl}" alt="Imagem do Post" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; margin-bottom: 10px; border: 1px solid #00ff96;">` : ''}
                <div class="post-content">${post.content}</div>
            `;
            feedContainer.appendChild(postElement);
        });
    }

    // --- Fun√ß√µes de Classifica√ß√£o (L√≥gica de Ordena√ß√£o) ---

    function calculateStats(stats) {
        stats.Saldo = stats.GolsPro - stats.GolsContra;
        return stats;
    }
    
    function compareTeams(a, b) {
        if (a.Pontos !== b.Pontos) return b.Pontos - a.Pontos;
        if (a.Vit√≥rias !== b.Vit√≥rias) return b.Vit√≥rias - a.Vit√≥rias;
        if (a.Saldo !== b.Saldo) return b.Saldo - a.Saldo;
        if (a.GolsPro !== b.GolsPro) return b.GolsPro - a.GolsPro;
        if (a.Team < b.Team) return -1;
        if (a.Team > b.Team) return 1;
        return 0;
    }
    
    function renderClassificationTables() {
        const teamStats = {};
        
        Object.keys(teamData).forEach(teamName => {
            teamStats[teamName] = { 
                Team: teamName, 
                Series: teamData[teamName].series,
                ...defaultStats
            };
        });
        
        allUsersCache.forEach(user => {
            if (user.teamName && teamStats[user.teamName] && user.stats) {
                // Ao inv√©s de sobrescrever, pegamos os dados e adicionamos o Time/S√©rie para a ordena√ß√£o.
                teamStats[user.teamName] = { 
                    Team: user.teamName, 
                    Series: teamData[user.teamName].series,
                    ...user.stats 
                };
            }
        });
        
        const serieA = Object.values(teamStats)
            .filter(t => t.Series === 'S√©rie A')
            .map(calculateStats)
            .sort(compareTeams);

        const serieB = Object.values(teamStats)
            .filter(t => t.Series === 'S√©rie B')
            .map(calculateStats)
            .sort(compareTeams);

        // Renderiza a Tabela A
        const tableA = document.getElementById('tabela-serie-a');
        const tbodyA = tableA.querySelector('tbody');
        tbodyA.innerHTML = '';
        serieA.forEach((team, index) => {
            const row = tbodyA.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><span class="team-link" onclick="openPerfilTime('${team.Team}')">${team.Team}</span></td>
                <td>${team.Pontos}</td>
                <td>${team.Jogos}</td>
                <td>${team.Vit√≥rias}</td>
                <td>${team.Empates}</td>
                <td>${team.Derrotas}</td>
                <td>${team.GolsPro}</td>
                <td>${team.GolsContra}</td>
                <td>${team.Saldo}</td>
            `;
        });
        document.getElementById('series-a-status').style.display = 'none';
        tableA.style.display = 'table';

        // Renderiza a Tabela B
        const tableB = document.getElementById('tabela-serie-b');
        const tbodyB = tableB.querySelector('tbody');
        tbodyB.innerHTML = '';
        serieB.forEach((team, index) => {
            const row = tbodyB.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><span class="team-link" onclick="openPerfilTime('${team.Team}')">${team.Team}</span></td>
                <td>${team.Pontos}</td>
                <td>${team.Jogos}</td>
                <td>${team.Vit√≥rias}</td>
                <td>${team.Empates}</td>
                <td>${team.Derrotas}</td>
                <td>${team.GolsPro}</td>
                <td>${team.GolsContra}</td>
                <td>${team.Saldo}</td>
            `;
        });
        document.getElementById('series-b-status').style.display = 'none';
        tableB.style.display = 'table';
    }

    // --- Fun√ß√µes da Lista de Times (Geral) ---

    function renderTeamsList() {
        const teamsContainer = document.getElementById('times-list');
        teamsContainer.innerHTML = '';
        
        const linkedUsers = allUsersCache.filter(u => u.teamName);
        const unlinkedTeams = Object.keys(teamData).filter(teamName => 
            !linkedUsers.some(u => u.teamName === teamName)
        );

        let html = '<h3 style="color:#00ff96; margin-top:0;">Times Vinculados a Usu√°rios</h3>';
        if (linkedUsers.length > 0) {
            linkedUsers.forEach(user => {
                const team = teamData[user.teamName];
                html += `
                    <div class="card" onclick="openPerfilTime('${user.teamName}')" style="cursor:pointer; display:flex; align-items:center; gap: 15px; margin-bottom: 10px; padding: 15px;">
                        <img src="${team.logo}" alt="${user.teamName} Logo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #f2c94c;">
                        <div>
                            <span style="font-weight: bold; color: #f2c94c; font-size: 1.2rem;">${user.teamName}</span> - <span style="font-size: 0.9em; color: #00ff96;">${team.series}</span>
                            <p style="margin: 5px 0 0 0; color: #ccc;">Gerente: ${user.userName || 'Nome n√£o definido'}</p>
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<p style="color:#ccc;">Nenhum time foi vinculado a um usu√°rio ainda.</p>';
        }

        html += '<h3 style="color:#ff004c; margin-top:30px;">Times Dispon√≠veis para V√≠nculo</h3>';
        if (unlinkedTeams.length > 0) {
            html += '<ul style="list-style: none; padding: 0;">';
            unlinkedTeams.forEach(teamName => {
                const team = teamData[teamName];
                html += `
                    <li style="padding: 5px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); display: flex; align-items: center;">
                        <img src="${team.logo}" alt="${teamName} Logo" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; margin-right: 10px;">
                        <span style="font-weight: bold;">${teamName}</span> - <span style="color:#999;">${team.series}</span>
                    </li>
                `;
            });
            html += '</ul>';
        } else {
            html += '<p style="color:#ccc;">Todos os times est√£o vinculados!</p>';
        }

        teamsContainer.innerHTML = html;
    }

    // --- Fun√ß√µes do Perfil do Time (Modal) ---
    
    function openPerfilTime(teamName) {
        const teamInfo = teamData[teamName];
        if (!teamInfo) {
            alert('Time n√£o encontrado.');
            return;
        }

        document.getElementById('perfil-time-nome').textContent = teamName;
        document.getElementById('perfil-time-logo').src = teamInfo.logo;
        document.getElementById('perfil-time-serie').textContent = teamInfo.series;

        // 1. Informa√ß√£o do Usu√°rio
        const teamOwner = allUsersCache.find(u => u.teamName === teamName);
        const ownerName = teamOwner ? (teamOwner.userName || teamOwner.email) : 'Gerente N√£o Atribu√≠do';
        document.getElementById('perfil-time-user-name').textContent = `Gerente: ${ownerName}`;
        
        // 2. Estat√≠sticas
        // Acessamos o objeto de estat√≠sticas do cache
        const userWithStats = allUsersCache.find(u => u.teamName === teamName && u.stats);
        const teamStats = userWithStats ? userWithStats.stats : defaultStats;

        const statsHtml = `
            <p><strong>Pontos:</strong> ${teamStats.Pontos}</p>
            <p><strong>Jogos:</strong> ${teamStats.Jogos}</p>
            <p><strong>Vit√≥rias/Empates/Derrotas:</strong> ${teamStats.Vit√≥rias} / ${teamStats.Empates} / ${teamStats.Derrotas}</p>
            <p><strong>Gols Pr√≥/Contra (Saldo):</strong> ${teamStats.GolsPro} / ${teamStats.GolsContra} (${calculateStats(teamStats).Saldo})</p>
        `;
        document.getElementById('perfil-time-stats').innerHTML = statsHtml;

        // 3. Posts Recentes
        const teamPosts = allPostsCache.filter(p => p.authorId === teamOwner?.uid);
        const feedContainer = document.getElementById('perfil-time-feed');
        feedContainer.innerHTML = '';
        if (teamPosts.length > 0) {
             teamPosts.slice(0, 3).forEach(post => { 
                let dateStr = post.timestamp && post.timestamp.toDate ? post.timestamp.toDate().toLocaleString('pt-BR', { day: 'numeric', month: 'short' }) : 'data indispon√≠vel';
                feedContainer.innerHTML += `
                    <div style="background: rgba(0,255,150,0.1); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                        <p style="font-size: 0.9em; color: #ccc;">${post.content}</p>
                        <span style="font-size: 0.75em; color: #999;">Publicado em ${dateStr}</span>
                    </div>
                `;
            });
        } else {
            feedContainer.innerHTML = '<p style="color:#ccc;">Este time ainda n√£o publicou nada.</p>';
        }

        document.getElementById('perfil-time').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }


    // --- Fun√ß√µes de Admin (Painel) ---
    
    function filterTeamsBySeries(series) {
        const team1Select = document.getElementById('jogo-time1');
        const team2Select = document.getElementById('jogo-time2');
        
        team1Select.innerHTML = '<option value="">-- Selecione o Time --</option>';
        team2Select.innerHTML = '<option value="">-- Selecione o Time --</option>';

        if (!series) return;

        const filteredTeams = Object.keys(teamData).filter(teamName => teamData[teamName].series === series);

        filteredTeams.forEach(teamName => {
            const option = `<option value="${teamName}">${teamName}</option>`;
            team1Select.innerHTML += option;
            team2Select.innerHTML += option;
        });
    }

    function renderAdminTeamList() {
        const listContainer = document.getElementById('admin-teams-list');
        if (!listContainer) return; 

        listContainer.innerHTML = '';
        
        const unlinkedTeams = Object.keys(teamData).filter(teamName => 
            !allUsersCache.some(u => u.teamName === teamName)
        );

        let html = '<h4 style="color:#00ff96; border-bottom: 1px dashed #00ff96; padding-bottom: 5px;">Usu√°rios Vinculados</h4>';
        
        // 1. Tabela de Usu√°rios com Times Vinculados
        const linkedUsers = allUsersCache.filter(u => u.teamName);
        if (linkedUsers.length > 0) {
            html += '<table style="font-size:0.9em;"><thead><tr><th>Usu√°rio</th><th>Time</th><th>A√ß√µes</th></tr></thead><tbody>';
            linkedUsers.forEach(user => {
                html += `
                    <tr>
                        <td style="text-align: left;">${user.userName || user.email}</td>
                        <td>${user.teamName}</td>
                        <td>
                            <button onclick="unlinkTeam('${user.uid}')" style="background:#ff004c; color:white; border:none; padding: 5px 10px; border-radius: 5px; cursor:pointer;">Desvincular</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
        } else {
            html += '<p style="color:#ccc;">Nenhum usu√°rio com time atribu√≠do.</p>';
        }
        
        // 2. Tabela de Times Dispon√≠veis para Atribui√ß√£o
        html += '<h4 style="color:#f2c94c; border-bottom: 1px dashed #f2c94c; padding-bottom: 5px; margin-top: 20px;">Atribuir Times Dispon√≠veis</h4>';

        if (unlinkedTeams.length > 0) {
            html += '<table style="font-size:0.9em;"><thead><tr><th>Time</th><th>S√©rie</th><th>Usu√°rio</th><th>A√ß√£o</th></tr></thead><tbody>';
            unlinkedTeams.forEach(teamName => {
                const userOptions = allUsersCache
                    .filter(u => !u.teamName) 
                    .map(u => `<option value="${u.uid}">${u.userName || u.email}</option>`)
                    .join('');

                html += `
                    <tr>
                        <td style="text-align: left;">${teamName}</td>
                        <td>${teamData[teamName].series}</td>
                        <td>
                            <select id="user-select-${teamName}" class="login-input" style="width:100%; padding: 5px; margin: 0;">
                                <option value="">-- Selecione o Usu√°rio --</option>
                                ${userOptions}
                            </select>
                        </td>
                        <td>
                            <button onclick="linkTeamToUser('${teamName}')" style="background:#00ff96; color:#0a1324; border:none; padding: 5px 10px; border-radius: 5px; cursor:pointer;">Vincular</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
        } else {
            html += '<p style="color:#ccc;">Todos os times est√£o vinculados!</p>';
        }

        listContainer.innerHTML += html;
    }

    async function linkTeamToUser(teamName) {
        const userSelect = document.getElementById(`user-select-${teamName}`);
        const userId = userSelect.value;
        const userName = userSelect.options[userSelect.selectedIndex].text;
        
        if (!userId) {
            alert('Selecione um usu√°rio para vincular.');
            return;
        }

        if (!confirm(`Tem certeza que deseja vincular o time ${teamName} ao usu√°rio ${userName}?`)) return;

        try {
            const initialStats = {
                Pontos: 0, Jogos: 0, Vit√≥rias: 0, Empates: 0, Derrotas: 0, GolsPro: 0, GolsContra: 0, Saldo: 0
            };
            
            await usersCollection.doc(userId).update({
                teamId: teamName, 
                teamName: teamName,
                stats: initialStats
            });
            
            alert(`‚úÖ ${teamName} vinculado a ${userName} com sucesso!`);
        } catch (error) {
            console.error("Erro ao vincular time:", error);
            alert("‚ùå Erro ao vincular time. Verifique suas regras de seguran√ßa.");
        }
    }

    async function unlinkTeam(userId) {
        const user = allUsersCache.find(u => u.uid === userId);
        if (!user || !user.teamName) return;

        if (!confirm(`Tem certeza que deseja desvincular o time ${user.teamName} do usu√°rio ${user.userName}?`)) return;

        try {
            await usersCollection.doc(userId).update({
                teamId: firebase.firestore.FieldValue.delete(),
                teamName: firebase.firestore.FieldValue.delete(),
                stats: firebase.firestore.FieldValue.delete()
            });
            
            alert(`‚úÖ Time ${user.teamName} desvinculado com sucesso!`);
        } catch (error) {
            console.error("Erro ao desvincular time:", error);
            alert("‚ùå Erro ao desvincular time. Verifique suas regras de seguran√ßa.");
        }
    }


    async function registrarResultado() {
        const series = document.getElementById('jogo-series').value;
        const time1 = document.getElementById('jogo-time1').value;
        const time2 = document.getElementById('jogo-time2').value;
        const gols1 = parseInt(document.getElementById('jogo-gols1').value);
        const gols2 = parseInt(document.getElementById('jogo-gols2').value);

        if (!series || !time1 || !time2 || isNaN(gols1) || isNaN(gols2) || time1 === time2) {
            alert('Preencha todos os campos corretamente e garanta que os times s√£o diferentes.');
            return;
        }

        if (!confirm(`Confirmar resultado: ${time1} ${gols1} x ${gols2} ${time2} (${series})?`)) return;

        try {
            const updateTeamStats = async (teamName, teamGols, oppGols) => {
                const user = allUsersCache.find(u => u.teamName === teamName);
                if (!user) {
                    console.warn(`Time ${teamName} n√£o est√° vinculado a um usu√°rio. Estat√≠sticas ignoradas.`);
                    return; 
                }
                
                let pontos = 0;
                let v = 0;
                let e = 0;
                let d = 0;

                if (teamGols > oppGols) {
                    pontos = 3; v = 1;
                } else if (teamGols === oppGols) {
                    pontos = 1; e = 1;
                } else {
                    d = 1;
                }

                const userRef = usersCollection.doc(user.uid);
                
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(userRef);
                    if (!doc.exists) return; 
                    
                    const currentStats = doc.data().stats || defaultStats;

                    const newStats = {
                        Pontos: currentStats.Pontos + pontos,
                        Jogos: currentStats.Jogos + 1,
                        Vit√≥rias: currentStats.Vit√≥rias + v,
                        Empates: currentStats.Empates + e,
                        Derrotas: currentStats.Derrotas + d,
                        GolsPro: currentStats.GolsPro + teamGols,
                        GolsContra: currentStats.GolsContra + oppGols,
                        Saldo: 0 // Ser√° redefinido na fun√ß√£o calculateStats (frontend)
                    };

                    transaction.update(userRef, { stats: newStats });
                });
            };

            await updateTeamStats(time1, gols1, gols2);
            await updateTeamStats(time2, gols2, gols1);
            
            await logsCollection.add({
                game: `${time1} ${gols1} x ${gols2} ${time2}`,
                series: series,
                adminId: loggedInUserUID,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert(`‚úÖ Resultado registrado: ${time1} ${gols1} x ${gols2} ${time2}. As tabelas foram atualizadas.`);
            
            // Limpa os campos do formul√°rio
            document.getElementById('jogo-series').value = '';
            document.getElementById('jogo-time1').innerHTML = '<option value="">-- Selecione o Time --</option>';
            document.getElementById('jogo-time2').innerHTML = '<option value="">-- Selecione o Time --</option>';
            document.getElementById('jogo-gols1').value = '';
            document.getElementById('jogo-gols2').value = '';

        } catch (error) {
            console.error("Erro ao registrar resultado:", error);
            alert("‚ùå Falha ao registrar resultado. Verifique o console para detalhes.");
        }
    }
</script>
</body>
</html>
